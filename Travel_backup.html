<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    :root{
      --bg:#f8fafc;
      --card:rgba(255, 255, 255, 0.9);
      --muted:#6b7280;
      --text:#0f172a;
      --primary:#2563eb;
      --accent:#0ea5a4;
      --radius:12px;
      --shadow:0 8px 26px rgba(15,23,42,0.06);
      --container:1100px;
      --bg-img:url('https://images.unsplash.com/photo-1542223616-1e7b2d2b02d9?auto=format&fit=crop&w=1500&q=80');
      --glass-bg: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
      --glass-border: 1px solid rgba(255, 255, 255, 0.2);
      --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    /* Dark mode variables */
    body.dark-mode {
      --bg: #0f172a;
      --card: #1e293b;
      --muted: #94a3b8;
      --text: #f1f5f9;
      --shadow: 0 8px 26px rgba(0, 0, 0, 0.3);
      --glass-bg: linear-gradient(135deg, rgba(30, 41, 59, 0.95), rgba(15, 23, 42, 0.9));
      --glass-border: 1px solid rgba(51, 65, 85, 0.5);
      --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    }

    body.dark-mode {
      background-image: linear-gradient(rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.95)), var(--bg-img);
    }

    body.dark-mode main {
      background: var(--glass-bg);
      border: var(--glass-border);
      box-shadow: var(--glass-shadow);
    }

    body.dark-mode header {
      background: linear-gradient(135deg, #1e293b, #0f172a);
      border: 1px solid rgba(51, 65, 85, 0.3);
    }

    body.dark-mode input[type="month"],
    body.dark-mode input[type="number"] {
      background: rgba(30, 41, 59, 0.9);
      border: 1px solid rgba(71, 85, 105, 0.5);
      color: var(--text);
    }

    body.dark-mode input:focus {
      background: rgba(30, 41, 59, 0.95);
      border-color: var(--accent);
    }

    body.dark-mode .expense-table {
      background: var(--card);
    }

    body.dark-mode .expense-table tr:hover {
      background-color: rgba(51, 65, 85, 0.3);
    }

    body.dark-mode .expense-table th,
    body.dark-mode .expense-table td {
      border-color: rgba(71, 85, 105, 0.5);
    }

    body.dark-mode .chart-wrapper {
      background: var(--card);
      border: 1px solid rgba(51, 65, 85, 0.3);
    }
    *{box-sizing:border-box}html,body{height:100%}
    body{margin:0;padding:28px;font-family:Inter, 'Segoe UI', Roboto;background-image:linear-gradient(rgba(255,255,255,0.86),rgba(255,255,255,0.86)),var(--bg-img);background-size:cover;background-position:center;color:var(--text)}
    main{
      max-width:var(--container);
      margin:0 auto;
      min-height:68vh;
      padding:28px;
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      border: var(--glass-border);
      border-radius: var(--radius);
      box-shadow: var(--glass-shadow);
    }
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap');
    header{display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#ffffff,#f8fafc);color:#0f172a;padding:16px 20px;border-radius:var(--radius);box-shadow:var(--shadow);margin-bottom:18px;border:1px solid rgba(2,6,23,0.08)}
    header h1{margin:0;font-size:1.6rem;font-family:'Poppins',sans-serif;font-weight:600;letter-spacing:0.5px;background:linear-gradient(90deg,var(--accent),var(--primary));-webkit-background-clip:text;background-clip:text;color:transparent}
    input{padding:10px;border-radius:10px;border:1px solid #e6eef8;background:#fff;min-width:150px;margin:8px}
    button{padding:10px 14px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--primary),var(--accent));color:#fff;cursor:pointer}
    .charts-container{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin:18px 0}
    .chart-wrapper{background:#fff;border-radius:12px;box-shadow:0 8px 24px rgba(2,6,23,0.06);padding:16px}
    .chart-wrapper h3{margin:0 0 12px 0;text-align:center;color:var(--text);font-size:1.1rem}
    canvas{display:block;margin:0 auto;max-width:100%}
    @media (max-width:768px){.charts-container{grid-template-columns:1fr}}
    footer{margin-top:36px;text-align:center;color:var(--muted)}

    /* 3-dots menu styles */
    .options-menu {
      position: relative;
      display: inline-block;
      margin-left: auto;
    }

    .options-button {
      background: linear-gradient(90deg, var(--primary), var(--accent));
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 18px;
      transition: all 0.3s ease;
    }

    .options-button:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }

    .options-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background: var(--card);
      border: var(--glass-border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      min-width: 200px;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      margin-top: 8px;
    }

    .options-dropdown.show {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .dropdown-item {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      transition: background-color 0.2s ease;
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--text);
    }

    .dropdown-item:hover {
      background-color: rgba(37, 99, 235, 0.1);
    }

    .dropdown-item:last-child {
      border-bottom: none;
    }

    body.dark-mode .options-dropdown {
      background: var(--card);
      border: 1px solid rgba(51, 65, 85, 0.5);
    }

    body.dark-mode .dropdown-item {
      border-bottom-color: rgba(71, 85, 105, 0.3);
    }

    body.dark-mode .dropdown-item:hover {
      background-color: rgba(51, 65, 85, 0.3);
    }

    /* Authentication styles */
    .auth-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .auth-form {
      background: var(--card);
      padding: 32px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      width: 100%;
      max-width: 400px;
      backdrop-filter: blur(10px);
    }

    .auth-form h2 {
      margin: 0 0 24px 0;
      text-align: center;
      color: var(--text);
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      margin-bottom: 4px;
      color: var(--text);
      font-weight: 500;
    }

    .form-group input {
      width: 100%;
      padding: 12px;
      border: 1px solid #e6eef8;
      border-radius: var(--radius);
      background: white;
      color: var(--text);
    }

    .auth-buttons {
      display: flex;
      gap: 8px;
      margin-top: 20px;
    }

    .btn-primary {
      flex: 1;
      padding: 12px;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      border: none;
      border-radius: var(--radius);
      color: white;
      cursor: pointer;
      font-weight: 500;
    }

    .btn-secondary {
      padding: 8px 16px;
      background: transparent;
      border: none;
      color: var(--accent);
      cursor: pointer;
      text-decoration: underline;
    }

    .hidden {
      display: none !important;
    }
  </style>
    </head>
    <body>
    <header>
      <img src="images/logo.png" alt="ExpenseWise Logo" class="site-logo">
      <h1>ExpenseWise</h1>
      <div class="options-menu">
        <button class="options-button" onclick="toggleOptionsMenu()">‚ãÆ</button>
        <div class="options-dropdown" id="optionsDropdown">
          <div class="dropdown-item" onclick="toggleDarkMode()">
            <span id="darkModeIcon">üåô</span>
            <span id="darkModeText">Dark Mode</span>
          </div>
          <div class="dropdown-item" onclick="goToHome()">
            <span>üè†</span>
            <span>Home</span>
          </div>
          <div class="dropdown-item" onclick="logout()">
            <span>üö™</span>
            <span>Logout</span>
          </div>
        </div>
      </div>
    </header>

    <!-- Authentication Container -->
    <div id="authContainer" class="auth-container hidden">
      <div class="auth-form">
        <div id="loginForm">
          <h2>Login to ExpenseWise</h2>
          <form id="loginFormElement">
            <div class="form-group">
              <label for="loginUsername">Username:</label>
              <input type="text" id="loginUsername" required>
            </div>
            <div class="form-group">
              <label for="loginPassword">Password:</label>
              <input type="password" id="loginPassword" required>
            </div>
            <div class="auth-buttons">
              <button type="submit" class="btn-primary">Login</button>
            </div>
          </form>
          <p style="text-align: center; margin-top: 16px; color: var(--muted);">
            Don't have an account? 
            <button type="button" class="btn-secondary" id="showRegister">Create Account</button>
          </p>
        </div>
        
        <div id="registerForm" class="hidden">
          <h2>Create Account</h2>
          <form id="registerFormElement">
            <div class="form-group">
              <label for="registerUsername">Username:</label>
              <input type="text" id="registerUsername" required>
            </div>
            <div class="form-group">
              <label for="fullName">Full Name:</label>
              <input type="text" id="fullName" required>
            </div>
            <div class="form-group">
              <label for="registerPassword">Password:</label>
              <input type="password" id="registerPassword" required>
            </div>
            <div class="form-group">
              <label for="confirmPassword">Confirm Password:</label>
              <input type="password" id="confirmPassword" required>
            </div>
            <div class="auth-buttons">
              <button type="submit" class="btn-primary">Create Account</button>
            </div>
          </form>
          <p style="text-align: center; margin-top: 16px; color: var(--muted);">
            Already have an account? 
            <button type="button" class="btn-secondary" id="showLogin">Login</button>
          </p>
        </div>
      </div>
    </div>
        
    <main>
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <h1>Travel Expenses</h1>
  <div style="margin-bottom: 20px;">
    <label for="expenseMonth">Select Month: </label>
    <input type="month" id="expenseMonth" style="padding: 10px; border-radius: 10px; border: 1px solid #e6eef8;" />
  </div>
  <input type="number" id="auto" placeholder="Auto (‚Çπ)" />
  <input type="number" id="bus" placeholder="Bus (‚Çπ)" />
  <input type="number" id="metro" placeholder="Metro (‚Çπ)" />
  <input type="number" id="petrol" placeholder="Petrol (‚Çπ)" />
  <button onclick="showChart()">Show Chart</button>
  <button onclick="clearAllData()" style="background: linear-gradient(90deg, #dc2626, #ef4444); margin-left: 10px;">Clear All Data</button>
  <div id="summary"></div>
  
  <div class="chart-wrapper" style="max-width: 900px; margin: 18px auto;">
    <h3>Monthly Trends</h3>
    <canvas id="monthlyChart"></canvas>
  </div>

  <div class="table-container" style="margin-top: 20px;">
    <table class="expense-table" style="width: 100%; border-collapse: collapse;">
      <thead>
        <tr>
          <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e6eef8;">Date</th>
          <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e6eef8;">Auto</th>
          <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e6eef8;">Bus</th>
          <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e6eef8;">Metro</th>
          <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e6eef8;">Petrol</th>
          <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e6eef8;">Total</th>
        </tr>
      </thead>
      <tbody id="expenseTableBody"></tbody>
      <tfoot>
        <tr>
          <td style="padding: 12px; font-weight: bold;">Total</td>
          <td id="totalAuto" style="padding: 12px;">‚Çπ0</td>
          <td id="totalBus" style="padding: 12px;">‚Çπ0</td>
          <td id="totalMetro" style="padding: 12px;">‚Çπ0</td>
          <td id="totalPetrol" style="padding: 12px;">‚Çπ0</td>
          <td id="grandTotal" style="padding: 12px; font-weight: bold;">‚Çπ0</td>
        </tr>
      </tfoot>
    </table>
  </div>

  <script>
    // User Authentication System
    class UserAuth {
      constructor() {
        this.currentUser = null;
        this.users = JSON.parse(localStorage.getItem('expenseWise_users') || '{}');
        this.init();
      }

      init() {
        // Check if user is already logged in
        const loggedInUser = localStorage.getItem('expenseWise_currentUser');
        if (loggedInUser && this.users[loggedInUser]) {
          this.loginUser(loggedInUser);
        } else {
          this.showAuth();
        }

        this.bindEvents();
      }

      bindEvents() {
        // Login form
        document.getElementById('loginFormElement').addEventListener('submit', (e) => {
          e.preventDefault();
          this.handleLogin();
        });

        // Register form
        document.getElementById('registerFormElement').addEventListener('submit', (e) => {
          e.preventDefault();
          this.handleRegister();
        });

        // Switch between forms
        document.getElementById('showRegister').addEventListener('click', () => {
          document.getElementById('loginForm').classList.add('hidden');
          document.getElementById('registerForm').classList.remove('hidden');
        });

        document.getElementById('showLogin').addEventListener('click', () => {
          document.getElementById('registerForm').classList.add('hidden');
          document.getElementById('loginForm').classList.remove('hidden');
        });
      }

      handleLogin() {
        const username = document.getElementById('loginUsername').value.trim();
        const password = document.getElementById('loginPassword').value;
        
        if (!username || !password) {
          alert('Please enter both username and password');
          return;
        }

        if (this.users[username]) {
          // Check password
          if (this.users[username].password === this.hashPassword(password)) {
            this.loginUser(username);
          } else {
            alert('Incorrect password. Please try again.');
          }
        } else {
          alert('Username not found. Please create an account first.');
        }
      }

      handleRegister() {
        const username = document.getElementById('registerUsername').value.trim();
        const fullName = document.getElementById('fullName').value.trim();
        const password = document.getElementById('registerPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (!username || !fullName || !password || !confirmPassword) {
          alert('Please fill in all fields');
          return;
        }

        if (password !== confirmPassword) {
          alert('Passwords do not match. Please try again.');
          return;
        }

        if (password.length < 6) {
          alert('Password must be at least 6 characters long.');
          return;
        }

        if (this.users[username]) {
          alert('Username already exists. Please choose a different one.');
          return;
        }

        // Create new user with hashed password
        this.users[username] = {
          fullName: fullName,
          password: this.hashPassword(password),
          createdAt: new Date().toISOString()
        };

        // Save users to localStorage
        localStorage.setItem('expenseWise_users', JSON.stringify(this.users));
        
        alert('Account created successfully!');
        this.loginUser(username);
      }

      // Simple password hashing (for demo - use proper hashing in production)
      hashPassword(password) {
        let hash = 0;
        for (let i = 0; i < password.length; i++) {
          const char = password.charCodeAt(i);
          hash = ((hash << 5) - hash) + char;
          hash = hash & hash; // Convert to 32-bit integer
        }
        return hash.toString();
      }

      loginUser(username) {
        this.currentUser = username;
        localStorage.setItem('expenseWise_currentUser', username);
        
        // Hide auth and show main content
        document.getElementById('authContainer').classList.add('hidden');
        
        // Load user's data
        this.loadUserData();
        
        // Reset forms
        document.getElementById('loginFormElement').reset();
        document.getElementById('registerFormElement').reset();
      }

      logout() {
        if (confirm('Are you sure you want to logout?')) {
          this.currentUser = null;
          localStorage.removeItem('expenseWise_currentUser');
          
          // Show auth
          this.showAuth();
        }
      }

      showAuth() {
        document.getElementById('authContainer').classList.remove('hidden');
        document.getElementById('loginForm').classList.remove('hidden');
        document.getElementById('registerForm').classList.add('hidden');
      }

      loadUserData() {
        // Load travel data for current user
        initializeTravel();
      }

      // Get user-specific localStorage key
      getUserKey(key) {
        return `${this.currentUser}_${key}`;
      }

      // User-specific localStorage methods
      setUserItem(key, value) {
        if (!this.currentUser) return;
        localStorage.setItem(this.getUserKey(key), value);
      }

      getUserItem(key) {
        if (!this.currentUser) return null;
        return localStorage.getItem(this.getUserKey(key));
      }

      removeUserItem(key) {
        if (!this.currentUser) return;
        localStorage.removeItem(this.getUserKey(key));
      }

      // Get all user-specific keys
      getUserKeys() {
        if (!this.currentUser) return [];
        const prefix = `${this.currentUser}_`;
        return Object.keys(localStorage).filter(key => key.startsWith(prefix));
      }
    }

    // Initialize auth system
    const userAuth = new UserAuth();
    
    // Make userAuth globally available
    window.userAuth = userAuth;

    // Dark mode functionality
    function toggleDarkMode() {
      const body = document.body;
      const isDark = body.classList.toggle('dark-mode');
      
      // Update icons and text
      const darkModeIcon = document.getElementById('darkModeIcon');
      const darkModeText = document.getElementById('darkModeText');
      
      if (isDark) {
        darkModeIcon.textContent = '‚òÄÔ∏è';
        darkModeText.textContent = 'Light Mode';
      } else {
        darkModeIcon.textContent = 'üåô';
        darkModeText.textContent = 'Dark Mode';
      }
      
      // Save preference
      localStorage.setItem('darkMode', isDark);
    }

    // Initialize dark mode
    function initializeDarkMode() {
      const isDarkMode = localStorage.getItem('darkMode') === 'true';
      if (isDarkMode) {
        document.body.classList.add('dark-mode');
        document.getElementById('darkModeIcon').textContent = '‚òÄÔ∏è';
        document.getElementById('darkModeText').textContent = 'Light Mode';
      }
    }

    // Options menu functionality
    function toggleOptionsMenu() {
      const dropdown = document.getElementById('optionsDropdown');
      dropdown.classList.toggle('show');
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
      const optionsMenu = document.querySelector('.options-menu');
      if (!optionsMenu.contains(event.target)) {
        document.getElementById('optionsDropdown').classList.remove('show');
      }
    });

    // Navigation functions
    function goToHome() {
      window.location.href = 'expense_manager_system.html';
    }

    function logout() {
      if (window.userAuth) {
        window.userAuth.logout();
      }
    }

    // Initialize when document is ready
    document.addEventListener('DOMContentLoaded', function() {
      initializeDarkMode();
    });

    function initializeTravel() {
      if (!window.userAuth || !window.userAuth.currentUser) {
        return; // Don't initialize if no user logged in
      }

      const today = new Date();
      const month = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0');
      document.getElementById('expenseMonth').value = month;
      
      // Set up event listeners
      document.getElementById('expenseMonth').addEventListener('change', function() {
        loadMonthlyData(this.value);
      });
      
      // Initial load
      loadMonthlyData(month);
    }

    function loadMonthlyData(month) {
      if (!window.userAuth || !window.userAuth.currentUser) {
        return; // Don't load if no user logged in
      }

      const savedData = window.userAuth.getUserItem('travelExpenses_' + month);
      if (savedData) {
        try {
          const data = JSON.parse(savedData);
          document.getElementById('auto').value = data.auto || '';
          document.getElementById('bus').value = data.bus || '';
          document.getElementById('metro').value = data.metro || '';
          document.getElementById('petrol').value = data.petrol || '';
          showChart();
        } catch (e) {
          console.error('Error loading data:', e);
        }
      } else {
        // Clear form if no data exists
        document.getElementById('auto').value = '';
        document.getElementById('bus').value = '';
        document.getElementById('metro').value = '';
        document.getElementById('petrol').value = '';
        document.getElementById('summary').innerHTML = '';
        if (window.travelChartInstance) {
          window.travelChartInstance.destroy();
          window.travelChartInstance = null;
        }
      }
      updateTable();
    }

    function updateTable() {
      if (!window.userAuth || !window.userAuth.currentUser) {
        return; // Don't update if no user logged in
      }

      const tableBody = document.getElementById('expenseTableBody');
      if (!tableBody) return;
      tableBody.innerHTML = '';

      const expenses = [];
      const userKeys = window.userAuth.getUserKeys();
      
      userKeys.forEach(key => {
        if (key.includes('travelExpenses_')) {
          try {
            const data = JSON.parse(window.userAuth.getUserItem(key.split('_').slice(1).join('_')));
            if (data && data.date) { 
              expenses.push(data); 
            }
          } catch (e) { 
            /* ignore malformed */ 
          }
        }
      });

      expenses.sort((a, b) => new Date(b.date) - new Date(a.date));

      let totalAuto = 0, totalBus = 0, totalMetro = 0, totalPetrol = 0;

      expenses.forEach(expense => {
        const row = document.createElement('tr');
        const total = (expense.auto || 0) + (expense.bus || 0) + (expense.metro || 0) + (expense.petrol || 0);
        row.innerHTML = `
          <td style="padding: 12px; border-bottom: 1px solid #e6eef8; cursor: pointer;" onclick="loadExpense('${expense.date}')">
            ${expense.date}
          </td>
          <td style="padding: 12px; border-bottom: 1px solid #e6eef8;">‚Çπ${expense.auto || 0}</td>
          <td style="padding: 12px; border-bottom: 1px solid #e6eef8;">‚Çπ${expense.bus || 0}</td>
          <td style="padding: 12px; border-bottom: 1px solid #e6eef8;">‚Çπ${expense.metro || 0}</td>
          <td style="padding: 12px; border-bottom: 1px solid #e6eef8;">‚Çπ${expense.petrol || 0}</td>
          <td style="padding: 12px; border-bottom: 1px solid #e6eef8;">‚Çπ${total}</td>
        `;

        tableBody.appendChild(row);

        totalAuto += expense.auto || 0;
        totalBus += expense.bus || 0;
        totalMetro += expense.metro || 0;
        totalPetrol += expense.petrol || 0;
      });

      document.getElementById('totalAuto').textContent = `‚Çπ${totalAuto}`;
      document.getElementById('totalBus').textContent = `‚Çπ${totalBus}`;
      document.getElementById('totalMetro').textContent = `‚Çπ${totalMetro}`;
      document.getElementById('totalPetrol').textContent = `‚Çπ${totalPetrol}`;
      document.getElementById('grandTotal').textContent = `‚Çπ${totalAuto + totalBus + totalMetro + totalPetrol}`;
    }

    function loadExpense(date) {
      if (!window.userAuth || !window.userAuth.currentUser) {
        return;
      }

      document.getElementById('expenseMonth').value = date;
      const savedData = window.userAuth.getUserItem(`travelExpenses_${date}`);
      if (savedData) {
        const data = JSON.parse(savedData);
        document.getElementById('auto').value = data.auto || '';
        document.getElementById('bus').value = data.bus || '';
        document.getElementById('metro').value = data.metro || '';
        document.getElementById('petrol').value = data.petrol || '';
        showChart();
      }
    }

    function showChart() {
      if (!window.userAuth || !window.userAuth.currentUser) {
        alert('Please log in to save expenses.');
        return;
      }

      const auto = parseInt(document.getElementById('auto').value) || 0;
      const bus = parseInt(document.getElementById('bus').value) || 0;
      const metro = parseInt(document.getElementById('metro').value) || 0;
      const petrol = parseInt(document.getElementById('petrol').value) || 0;
      const total = auto + bus + metro + petrol;

      // Get the month (YYYY-MM)
      const monthKey = document.getElementById('expenseMonth').value;
      
      // Save data to user-specific localStorage
      window.userAuth.setUserItem('travelExpenses_' + monthKey, JSON.stringify({ 
        date: monthKey,
        auto: auto, 
        bus: bus, 
        metro: metro,
        petrol: petrol
      }));

      // Update the table
      updateTable();
      
      // Update summary
      document.getElementById('summary').innerHTML = `<h3>Total Travel Expenses: ‚Çπ${total}</h3>`;

      // Update monthly chart
      updateMonthlyChart();
    }

    function updateMonthlyChart() {
      if (!window.userAuth || !window.userAuth.currentUser) {
        return;
      }

      // Get all expenses and group by month
      const monthlyData = {};
      const userKeys = window.userAuth.getUserKeys();
      
      userKeys.forEach(key => {
        if (key.includes('travelExpenses_')) {
          try {
            const keyWithoutUser = key.split('_').slice(1).join('_');
            const data = JSON.parse(window.userAuth.getUserItem(keyWithoutUser));
            const month = data.date.substring(0, 7); // Get YYYY-MM
            
            if (!monthlyData[month]) {
              monthlyData[month] = { auto: 0, bus: 0, metro: 0, petrol: 0 };
            }
            
            monthlyData[month].auto += data.auto;
            monthlyData[month].bus += data.bus;
            monthlyData[month].metro += data.metro;
            monthlyData[month].petrol += data.petrol;
          } catch (e) {
            /* ignore malformed data */
          }
        }
      });
      
      // Sort months
      const sortedMonths = Object.keys(monthlyData).sort();
      const last6Months = sortedMonths.slice(-6); // Get last 6 months
      
      const autoData = last6Months.map(m => monthlyData[m].auto);
      const busData = last6Months.map(m => monthlyData[m].bus);
      const metroData = last6Months.map(m => monthlyData[m].metro);
      const petrolData = last6Months.map(m => monthlyData[m].petrol);
      
      // Format month labels
      const monthLabels = last6Months.map(m => {
        const [year, month] = m.split('-');
        const date = new Date(year, month - 1);
        return date.toLocaleString('default', { month: 'short', year: '2-digit' });
      });
      
      // Destroy existing monthly chart if it exists
      const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
      if (window.monthlyChartInstance instanceof Chart) {
        window.monthlyChartInstance.destroy();
      }
      
      // Create monthly bar chart
      window.monthlyChartInstance = new Chart(monthlyCtx, {
        type: 'bar',
        data: {
          labels: monthLabels,
          datasets: [
            {
              label: 'Auto',
              data: autoData,
              backgroundColor: 'rgba(255, 99, 132, 0.8)',
              borderColor: 'rgba(255, 99, 132, 1)',
              borderWidth: 2,
              borderRadius: 8,
              borderSkipped: false,
            },
            {
              label: 'Bus',
              data: busData,
              backgroundColor: 'rgba(54, 162, 235, 0.8)',
              borderColor: 'rgba(54, 162, 235, 1)',
              borderWidth: 2,
              borderRadius: 8,
              borderSkipped: false,
            },
            {
              label: 'Metro',
              data: metroData,
              backgroundColor: 'rgba(255, 206, 86, 0.8)',
              borderColor: 'rgba(255, 206, 86, 1)',
              borderWidth: 2,
              borderRadius: 8,
              borderSkipped: false,
            },
            {
              label: 'Petrol',
              data: petrolData,
              backgroundColor: 'rgba(75, 192, 192, 0.8)',
              borderColor: 'rgba(75, 192, 192, 1)',
              borderWidth: 2,
              borderRadius: 8,
              borderSkipped: false,
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              padding: 12,
              titleColor: '#fff',
              bodyColor: '#fff',
              borderColor: 'rgba(255, 255, 255, 0.2)',
              borderWidth: 1,
              displayColors: true,
              callbacks: {
                label: function(context) {
                  return `${context.dataset.label}: ‚Çπ${context.raw}`;
                }
              }
            },
            legend: { 
              position: 'top',
              labels: {
                padding: 15,
                font: {
                  size: 12,
                  weight: '500'
                },
                usePointStyle: true,
                pointStyle: 'circle'
              }
            }
          },
          scales: {
            x: {
              stacked: true,
              grid: {
                display: false
              },
              ticks: {
                font: {
                  size: 11,
                  weight: '500'
                }
              }
            },
            y: {
              stacked: true,
              beginAtZero: true,
              grid: {
                color: 'rgba(0, 0, 0, 0.05)',
                lineWidth: 1
              },
              ticks: {
                callback: function(value) {
                  return '‚Çπ' + value;
                },
                font: {
                  size: 11
                }
              }
            }
          }
        }
      });
    }

    // Clear all travel expense data for current user
    function clearAllData() {
      if (!window.userAuth || !window.userAuth.currentUser) {
        alert('Please log in first.');
        return;
      }

      if (confirm('Are you sure you want to clear all travel expense data? This cannot be undone.')) {
        // Get all user keys
        const userKeys = window.userAuth.getUserKeys();
        
        // Remove only travel-related data for current user
        let deletedCount = 0;
        userKeys.forEach(key => {
          if (key.includes('travelExpenses_')) {
            const keyWithoutUser = key.split('_').slice(1).join('_');
            window.userAuth.removeUserItem(keyWithoutUser);
            deletedCount++;
          }
        });
        
        // Clear form fields
        document.getElementById('auto').value = '';
        document.getElementById('bus').value = '';
        document.getElementById('metro').value = '';
        document.getElementById('petrol').value = '';
        
        // Clear charts
        if (window.monthlyChartInstance) {
          window.monthlyChartInstance.destroy();
          window.monthlyChartInstance = null;
        }
        
        // Clear summary
        document.getElementById('summary').innerHTML = '';
        
        // Update table
        updateTable();
        
        alert(`Successfully cleared ${deletedCount} travel expense records.`);
      }
    }

    // Expose functions globally
    window.showChart = showChart;
    window.loadExpense = loadExpense;
    window.clearAllData = clearAllData;
    window.toggleDarkMode = toggleDarkMode;
    window.toggleOptionsMenu = toggleOptionsMenu;
    window.goToHome = goToHome;
    window.logout = logout;
  </script>
    </main>

    <footer>
    Beware of little expenses. A small leak will sink a great ship.
    </footer>
    </Body>
</html>
