<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device-Specific Storage Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .test-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .test-button {
            background: linear-gradient(90deg, #4f46e5, #7c3aed);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 8px;
            transition: all 0.3s;
            font-weight: 500;
        }
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .result {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            border-left: 4px solid #4f46e5;
        }
        .device-info {
            background: linear-gradient(90deg, #059669, #0d9488);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        h2 {
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 10px;
        }
        .warning {
            background: linear-gradient(90deg, #dc2626, #ef4444);
            padding: 10px 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>üîí Device-Specific Storage Test</h1>
    
    <div id="device-info" class="device-info">
        <h3>üì± Current Device Information</h3>
        <div id="current-device"></div>
    </div>

    <div class="test-section">
        <h2>1. Device Fingerprint Test</h2>
        <p>Test device fingerprinting that creates unique device IDs.</p>
        <button class="test-button" onclick="testDeviceFingerprint()">Generate Device ID</button>
        <div id="fingerprint-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>2. Device-Specific Account Storage</h2>
        <p>Test how user accounts are stored with device-specific keys.</p>
        <button class="test-button" onclick="createTestAccounts()">Create Test Accounts</button>
        <button class="test-button" onclick="showDeviceAccounts()">Show Device Accounts</button>
        <div id="accounts-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>3. Device-Specific Remember Me</h2>
        <p>Test device-specific credential storage.</p>
        <button class="test-button" onclick="testRememberMe()">Test Remember Me</button>
        <div id="remember-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>4. Device Change Simulation</h2>
        <p>Simulate what happens when device fingerprint changes.</p>
        <div class="warning">‚ö†Ô∏è Warning: This will clear all current device data!</div>
        <button class="test-button" onclick="simulateDeviceChange()">Simulate Device Change</button>
        <div id="device-change-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>5. Storage Analysis</h2>
        <p>Analyze all storage keys and their device association.</p>
        <button class="test-button" onclick="analyzeStorage()">Analyze Storage</button>
        <button class="test-button" onclick="clearTestData()">Clear Test Data</button>
        <div id="storage-result" class="result"></div>
    </div>

    <script>
        // Device fingerprinting function (same as in auth.js)
        function generateDeviceFingerprint() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.fillText('Device fingerprint', 2, 2);
            
            const fingerprint = [
                navigator.userAgent,
                navigator.language,
                screen.width + 'x' + screen.height,
                screen.colorDepth,
                new Date().getTimezoneOffset(),
                navigator.hardwareConcurrency || 'unknown',
                navigator.platform,
                canvas.toDataURL()
            ].join('|');
            
            let hash = 0;
            for (let i = 0; i < fingerprint.length; i++) {
                const char = fingerprint.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash).toString(16);
        }

        function getCurrentDeviceId() {
            let deviceId = localStorage.getItem('deviceFingerprint');
            if (!deviceId) {
                deviceId = generateDeviceFingerprint();
                localStorage.setItem('deviceFingerprint', deviceId);
            }
            return deviceId;
        }

        function displayDeviceInfo() {
            const deviceInfo = {
                'Device ID': getCurrentDeviceId(),
                'User Agent': navigator.userAgent.substring(0, 60) + '...',
                'Platform': navigator.platform,
                'Language': navigator.language,
                'Screen': screen.width + 'x' + screen.height,
                'Color Depth': screen.colorDepth + ' bits',
                'Timezone': 'UTC' + (new Date().getTimezoneOffset() / -60),
                'CPU Cores': navigator.hardwareConcurrency || 'unknown'
            };

            let output = '';
            Object.entries(deviceInfo).forEach(([key, value]) => {
                output += `<strong>${key}:</strong> ${value}<br>`;
            });

            document.getElementById('current-device').innerHTML = output;
        }

        function testDeviceFingerprint() {
            const result = document.getElementById('fingerprint-result');
            let output = "Device Fingerprint Generation Test...\n\n";

            const deviceId = getCurrentDeviceId();
            const newFingerprint = generateDeviceFingerprint();

            output += `Current Device ID: ${deviceId}\n`;
            output += `Fresh Fingerprint: ${newFingerprint}\n`;
            output += `Match: ${deviceId === newFingerprint ? '‚úÖ YES' : '‚ùå NO'}\n\n`;

            // Show fingerprint components
            output += "Fingerprint Components:\n";
            output += `‚Ä¢ User Agent: ${navigator.userAgent.substring(0, 40)}...\n`;
            output += `‚Ä¢ Platform: ${navigator.platform}\n`;
            output += `‚Ä¢ Screen: ${screen.width}x${screen.height}\n`;
            output += `‚Ä¢ Language: ${navigator.language}\n`;
            output += `‚Ä¢ Timezone: UTC${new Date().getTimezoneOffset() / -60}\n`;
            output += `‚Ä¢ CPU Cores: ${navigator.hardwareConcurrency || 'unknown'}\n`;

            result.textContent = output;
        }

        function createTestAccounts() {
            const result = document.getElementById('accounts-result');
            let output = "Creating Device-Specific Test Accounts...\n\n";

            const deviceId = getCurrentDeviceId();
            const deviceKey = `expenseWiseUsers_DEVICE_${deviceId}`;

            const testUsers = [
                { id: Date.now(), username: 'alice_device', fullName: 'Alice Device', password: 'pass123' },
                { id: Date.now() + 1, username: 'bob_device', fullName: 'Bob Device', password: 'pass456' },
                { id: Date.now() + 2, username: 'charlie_device', fullName: 'Charlie Device', password: 'pass789' }
            ];

            localStorage.setItem(deviceKey, JSON.stringify(testUsers));
            output += `‚úÖ Created ${testUsers.length} test accounts for device: ${deviceId}\n`;
            output += `Storage Key: ${deviceKey}\n\n`;

            testUsers.forEach(user => {
                output += `üë§ ${user.fullName} (@${user.username})\n`;
            });

            result.textContent = output;
        }

        function showDeviceAccounts() {
            const result = document.getElementById('accounts-result');
            let output = "Device-Specific Accounts Analysis...\n\n";

            const deviceId = getCurrentDeviceId();
            const deviceKey = `expenseWiseUsers_DEVICE_${deviceId}`;

            output += `Current Device: ${deviceId}\n`;
            output += `Looking for key: ${deviceKey}\n\n`;

            const users = localStorage.getItem(deviceKey);
            if (users) {
                const parsedUsers = JSON.parse(users);
                output += `‚úÖ Found ${parsedUsers.length} accounts on this device:\n\n`;
                parsedUsers.forEach(user => {
                    output += `üë§ ${user.fullName} (@${user.username})\n`;
                    output += `   ID: ${user.id}\n`;
                    output += `   Created: ${user.createdAt || 'Unknown'}\n\n`;
                });
            } else {
                output += `‚ùå No accounts found for this device\n`;
            }

            // Check for other device accounts
            output += "\nChecking for other device accounts...\n";
            let otherDeviceCount = 0;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('expenseWiseUsers_DEVICE_') && key !== deviceKey) {
                    otherDeviceCount++;
                    const otherDeviceId = key.replace('expenseWiseUsers_DEVICE_', '');
                    output += `üîí Found accounts for device: ${otherDeviceId} (hidden)\n`;
                }
            }

            if (otherDeviceCount === 0) {
                output += "‚úÖ No other device accounts found\n";
            }

            result.textContent = output;
        }

        function testRememberMe() {
            const result = document.getElementById('remember-result');
            let output = "Testing Device-Specific Remember Me...\n\n";

            const deviceId = getCurrentDeviceId();
            const testUsername = 'test_remember_user';
            const testPassword = 'remember_pass123';

            // Create device-specific keys
            const rememberedUserKey = `rememberedUser_DEVICE_${deviceId}`;
            const savedCredentialsKey = `savedCredentials_DEVICE_${deviceId}_${testUsername}`;

            // Save remember me data
            localStorage.setItem(rememberedUserKey, JSON.stringify({
                username: testUsername,
                savedAt: new Date().toISOString()
            }));

            localStorage.setItem(savedCredentialsKey, JSON.stringify({
                password: testPassword,
                savedAt: new Date().toISOString()
            }));

            output += `‚úÖ Saved remember me data for device: ${deviceId}\n\n`;
            output += `Remembered User Key: ${rememberedUserKey}\n`;
            output += `Credentials Key: ${savedCredentialsKey}\n\n`;

            // Test retrieval
            const rememberedUser = localStorage.getItem(rememberedUserKey);
            const savedCreds = localStorage.getItem(savedCredentialsKey);

            if (rememberedUser && savedCreds) {
                const userInfo = JSON.parse(rememberedUser);
                const credInfo = JSON.parse(savedCreds);
                
                output += `‚úÖ Successfully retrieved:\n`;
                output += `‚Ä¢ Username: ${userInfo.username}\n`;
                output += `‚Ä¢ Password: ${'*'.repeat(credInfo.password.length)}\n`;
                output += `‚Ä¢ Saved At: ${userInfo.savedAt}\n\n`;
            }

            // Test device isolation
            output += "Testing device isolation...\n";
            const fakeDeviceId = 'fake_device_12345';
            const fakeKey = `savedCredentials_DEVICE_${fakeDeviceId}_${testUsername}`;
            const fakeData = localStorage.getItem(fakeKey);
            
            output += `Fake device key: ${fakeKey}\n`;
            output += `Can access fake device data: ${fakeData ? '‚ùå YES (PROBLEM!)' : '‚úÖ NO (SECURE)'}\n`;

            result.textContent = output;
        }

        function simulateDeviceChange() {
            const result = document.getElementById('device-change-result');
            
            if (!confirm('This will simulate a device change and clear all device-specific data. Continue?')) {
                result.textContent = "Device change simulation cancelled.";
                return;
            }

            let output = "Simulating Device Change...\n\n";

            // Store current device info
            const oldDeviceId = getCurrentDeviceId();
            output += `Old Device ID: ${oldDeviceId}\n`;

            // Count current data
            let dataCount = 0;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && (
                    key.includes('_DEVICE_') ||
                    key === 'expenseWiseSession' ||
                    key.startsWith('rememberedUser') ||
                    key.startsWith('savedCredentials_')
                )) {
                    dataCount++;
                }
            }
            output += `Current device data items: ${dataCount}\n\n`;

            // Clear device fingerprint to simulate device change
            localStorage.removeItem('deviceFingerprint');

            // Force regenerate device ID (simulate different device)
            const tempUserAgent = navigator.userAgent;
            Object.defineProperty(navigator, 'userAgent', {
                value: tempUserAgent + '_SIMULATED_DEVICE_CHANGE',
                writable: false
            });

            const newDeviceId = generateDeviceFingerprint();
            localStorage.setItem('deviceFingerprint', newDeviceId);

            output += `‚úÖ Device change simulated!\n`;
            output += `New Device ID: ${newDeviceId}\n\n`;

            // Check what data is accessible now
            let accessibleData = 0;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.includes(`_DEVICE_${newDeviceId}`)) {
                    accessibleData++;
                }
            }

            output += `Accessible data for new device: ${accessibleData}\n`;
            output += `Data isolation working: ${accessibleData === 0 ? '‚úÖ YES' : '‚ùå NO'}\n\n`;

            output += "‚ö†Ô∏è Note: In a real device change, the browser would have:\n";
            output += "‚Ä¢ Different user agent\n";
            output += "‚Ä¢ Different screen resolution\n";
            output += "‚Ä¢ Different hardware capabilities\n";
            output += "‚Ä¢ Different timezone possibly\n";
            output += "‚Ä¢ Completely clean localStorage\n";

            result.textContent = output;
        }

        function analyzeStorage() {
            const result = document.getElementById('storage-result');
            let output = "Storage Analysis...\n\n";

            const currentDeviceId = getCurrentDeviceId();
            output += `Current Device ID: ${currentDeviceId}\n\n`;

            const categories = {
                'Device-Specific Users': [],
                'Device-Specific Remember Me': [],
                'Device-Specific Credentials': [],
                'User Expense Data': [],
                'System Data': [],
                'Other': []
            };

            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                const size = value ? value.length : 0;
                const item = `${key} (${size} chars)`;

                if (key.startsWith('expenseWiseUsers_DEVICE_')) {
                    categories['Device-Specific Users'].push(item);
                } else if (key.startsWith('rememberedUser_DEVICE_')) {
                    categories['Device-Specific Remember Me'].push(item);
                } else if (key.startsWith('savedCredentials_DEVICE_')) {
                    categories['Device-Specific Credentials'].push(item);
                } else if (key.includes('USER_') && key.includes('_EXPENSES')) {
                    categories['User Expense Data'].push(item);
                } else if (key === 'deviceFingerprint' || key === 'expenseWiseSession' || key === 'theme') {
                    categories['System Data'].push(item);
                } else {
                    categories['Other'].push(item);
                }
            }

            Object.entries(categories).forEach(([category, items]) => {
                output += `üìÅ ${category} (${items.length}):\n`;
                if (items.length === 0) {
                    output += "   (empty)\n";
                } else {
                    items.forEach(item => {
                        const isCurrentDevice = item.includes(currentDeviceId);
                        output += `   ${isCurrentDevice ? 'üîì' : 'üîí'} ${item}\n`;
                    });
                }
                output += "\n";
            });

            output += "Legend:\n";
            output += "üîì = Accessible on current device\n";
            output += "üîí = Hidden from current device\n";

            result.textContent = output;
        }

        function clearTestData() {
            const result = document.getElementById('storage-result');
            
            if (!confirm('Clear all test data? This will remove test accounts and remember me data.')) {
                result.textContent = "Clear operation cancelled.";
                return;
            }

            let output = "Clearing test data...\n\n";
            let deletedCount = 0;

            const keysToDelete = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && (
                    key.includes('test_remember_user') ||
                    key.includes('_device') ||
                    key.includes('alice_device') ||
                    key.includes('bob_device') ||
                    key.includes('charlie_device')
                )) {
                    keysToDelete.push(key);
                }
            }

            keysToDelete.forEach(key => {
                localStorage.removeItem(key);
                deletedCount++;
                output += `üóëÔ∏è Removed: ${key}\n`;
            });

            output += `\n‚úÖ Cleared ${deletedCount} test items.`;
            result.textContent = output;
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            displayDeviceInfo();
        });
    </script>
</body>
</html>