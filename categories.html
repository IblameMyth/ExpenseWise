<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Categories - ExpenseWise</title>
    <link rel="stylesheet" href="styles.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <!-- Firebase Configuration -->
    <script src="firebase-config.js"></script>
    
    <!-- Unified Services -->
    <script src="js/database-service.js"></script>
    <script src="js/app-service.js"></script>
    <style>
        :root{
            --bg:#0f172a;
            --card:rgba(30, 41, 59, 0.9);
            --muted:#e2e8f0;
            --text:#ffffff;
            --primary:#3b82f6;
            --accent:#10b981;
            --radius:16px;
            --shadow:0 25px 50px rgba(0, 0, 0, 0.3);
            --container:1100px;
            --glass-bg: linear-gradient(135deg, rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.3));
            --glass-border: 1px solid rgba(255, 255, 255, 0.2);
            --glass-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        [data-theme="light"] {
            --bg: #f1f5f9;
            --card: rgba(255, 255, 255, 0.95);
            --muted: #64748b;
            --text: #0f172a;
            --glass-bg: linear-gradient(135deg, rgba(255, 255, 255, 0.6), rgba(255, 255, 255, 0.4));
            --glass-border: 1px solid rgba(0, 0, 0, 0.1);
            --glass-shadow: 0 25px 50px rgba(0, 0, 0, 0.1);
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        [data-theme="dark"] {
            --bg: #0f172a;
            --card: rgba(30, 41, 59, 0.9);
            --muted: #e2e8f0;
            --text: #ffffff;
            --glass-bg: linear-gradient(135deg, rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.3));
            --glass-border: 1px solid rgba(255, 255, 255, 0.2);
            --glass-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
        }

        *{box-sizing:border-box}
        html,body{height:100%}
        html{background:var(--bg-gradient)}
        [data-theme="dark"] html{background:var(--bg-gradient)}

        body{
            margin:0;padding:28px;font-family:'Inter', 'Segoe UI', Roboto, system-ui;background:var(--bg-gradient);color:var(--text);min-height:100vh;overflow-x:hidden;
        }

        main{
            max-width:var(--container);
            margin:0 auto;
            min-height:68vh;
            padding:28px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: var(--glass-border);
            border-radius: var(--radius);
            box-shadow: var(--glass-shadow);
        }

        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap');
        header{display:flex;align-items:center;justify-content:space-between;background:rgba(0, 0, 0, 0.3);color:var(--text);padding:16px 20px;border-radius:var(--radius);box-shadow:0 15px 30px rgba(0, 0, 0, 0.4);margin-bottom:18px;border:1px solid rgba(255, 255, 255, 0.2);backdrop-filter:blur(10px);text-shadow:0 1px 2px rgba(0, 0, 0, 0.5)}
        header h1{margin:0;font-size:1.6rem;font-family:'Poppins',sans-serif;font-weight:600;letter-spacing:0.5px;background:linear-gradient(90deg, #ffffff, #f0f9ff);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;text-shadow:0 2px 4px rgba(0, 0, 0, 0.5);filter:drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5))}

        [data-theme="dark"] header {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text);
            backdrop-filter: blur(10px);
        }

        .theme-toggle {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease;
        }

        .theme-toggle:hover {
            background: var(--accent);
        }

        /* Category Tabs */
        .category-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            flex-wrap: wrap;
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: var(--radius);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }

        .tab-btn {
            padding: 10px 16px;
            border: 2px solid transparent;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            color: var(--text);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        .tab-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
        }

        .tab-btn.active {
            background: linear-gradient(90deg, var(--primary), var(--accent));
            color: white;
            border-color: transparent;
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
        }

        .category-content {
            display: none;
        }

        .category-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(50px) translateZ(0);
            }
            to {
                opacity: 1;
                transform: translateY(0) translateZ(0);
            }
        }

        /* Animation performance optimization */
        * {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        main,
        .tab-btn,
        button,
        input,
        .chart-wrapper,
        header {
            transform: translateZ(0);
            will-change: auto;
            backface-visibility: hidden;
        }

        .tab-btn,
        button {
            will-change: transform, background, box-shadow;
        }

        input {
            will-change: border-color, box-shadow, background;
        }

        form{display:flex;flex-wrap:wrap;gap:10px;justify-content:center}
        input{padding:10px;border-radius:10px;border:1px solid rgba(255, 255, 255, 0.2);background:rgba(0, 0, 0, 0.3);min-width:150px;color:var(--text);backdrop-filter:blur(10px);text-shadow:0 1px 2px rgba(0, 0, 0, 0.5)}
        button{padding:10px 14px;border-radius:10px;border:1px solid rgba(255, 255, 255, 0.2);background:linear-gradient(90deg,var(--primary),var(--accent));color:#fff;cursor:pointer;box-shadow:0 8px 20px rgba(59, 130, 246, 0.3);text-shadow:0 1px 2px rgba(0, 0, 0, 0.5);transition:all 0.3s ease}

        [data-theme="dark"] input {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text);
        }

        [data-theme="dark"] input[type="month"] {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text);
        }

        #summary{
            margin-top:12px;
            font-weight:600;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: var(--radius);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            color: var(--text);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        .charts-container{
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 18px 0;
        }

        .chart-wrapper{
            background: rgba(0, 0, 0, 0.3);
            border-radius: var(--radius);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
            padding:16px;
            backdrop-filter: blur(10px);
        }

        .chart-wrapper h3{
            margin: 0 0 12px 0;
            text-align: center;
            color: var(--text);
            font-size: 1.1rem;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        canvas{
            display:block;
            margin:0 auto;
            max-width:100%;
        }

        @media (max-width: 768px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
            .category-tabs {
                flex-direction: column;
            }
        }

        .table-container {
            margin-top: 30px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: var(--radius);
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
        }

        .table-container .expense-table {
            background: transparent;
            box-shadow: none;
            border: none;
        }

        footer{margin-top:36px;text-align:center;color:var(--text);opacity:0.8;padding:18px 12px}
        footer a{color:var(--primary);text-decoration:none;margin:0 10px;transition:opacity 0.3s ease}
        footer a:hover{opacity:0.7;text-decoration:underline}
        [data-theme="light"] footer{color:var(--text)}
        [data-theme="dark"] footer{color:var(--text)}
    </style>
</head>
<body>
    <header>
        <div style="display: flex; align-items: center; gap: 12px;">
            <img src="images/logo.png" alt="ExpenseWise Logo" class="site-logo">
            <h1>ExpenseWise</h1>
        </div>
        <div style="display: flex; align-items: center; gap: 12px;">
            <div id="userStatusBox" style="padding: 6px 12px; background: rgba(0,0,0,0.3); border-radius: 6px; font-size: 12px; border: 1px solid rgba(255,255,255,0.2); color: #f59e0b;">
                üë§ Loading...
            </div>
            <button onclick="window.location.href='welcome.html'" style="background: var(--accent); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 14px;">üè† Home</button>
            <button onclick="window.location.href='ExpenseWise Main.html'" style="background: var(--primary); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 14px;">üìä Dashboard</button>
            <button class="theme-toggle" onclick="toggleTheme()">üåô Dark Mode</button>
        </div>
    </header>

    <main>
        <h2>Expense Categories</h2>
        
        <!-- Category Tabs -->
        <div class="category-tabs">
            <button class="tab-btn active" onclick="switchCategory('household', this)">üè† Household</button>
            <button class="tab-btn" onclick="switchCategory('travel', this)">‚úàÔ∏è Travel</button>
            <button class="tab-btn" onclick="switchCategory('entertainment', this)">üé¨ Entertainment</button>
            <button class="tab-btn" onclick="switchCategory('emi', this)">üí≥ EMI</button>
            <button class="tab-btn" onclick="switchCategory('vacation', this)">üèñÔ∏è Vacation</button>
            <button class="tab-btn" onclick="switchCategory('future', this)">üìÖ Future Expenses</button>
        </div>

        <!-- HOUSEHOLD CATEGORY -->
        <div id="household" class="category-content active">
            <h3>üè† Household Expenses</h3>
            <div style="margin-bottom: 20px;">
                <label for="householdMonth">Select Month: </label>
                <input type="month" id="householdMonth" style="padding: 10px; border-radius: 10px; border: 1px solid #e6eef8;" />
            </div>
            <input type="number" id="groceries" placeholder="Groceries" />
            <input type="number" id="householdSupplies" placeholder="Household Supplies" />
            <input type="number" id="personal" placeholder="Personal" />
            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; margin-bottom: 15px;">
              <button onclick="saveHouseholdData()">Save Data</button>
              <button id="toggleHouseholdTableBtn" onclick="toggleHouseholdTableVisibility()">Show Table</button>
              <button onclick="clearHouseholdData()" style="background: linear-gradient(90deg, #dc2626, #ef4444);">Clear All Data</button>
              <button onclick="toggleHouseholdMonthlyOptions()" style="background: linear-gradient(90deg, #f59e0b, #f97316);">Clear Monthly Data</button>
            </div>
            
            <!-- Household Clear Monthly Data Section -->
            <div id="householdMonthlyOptions" style="display:none; margin-top:15px; padding:12px; background:rgba(255,255,255,0.05); border-radius:8px;">
              <div style="margin-bottom:10px;">
                <label>Select Month to Clear: </label>
                <input type="month" id="householdClearMonth" style="padding: 8px; border-radius: 6px; border: 1px solid #e6eef8;" />
              </div>
              <button onclick="clearHouseholdMonthlyData()" style="background: #dc2626; padding:8px 12px; border-radius:6px; border:none; color:white; cursor:pointer; margin-right:8px;">Delete Month Data</button>
              <button onclick="toggleHouseholdMonthlyOptions()" style="background: #64748b; padding:8px 12px; border-radius:6px; border:none; color:white; cursor:pointer;">Cancel</button>
            </div>
            
            <div id="householdSummary"></div>
            <div class="table-container" id="householdTableContainer" style="display: none;">
                <table class="expense-table" style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e6eef8;">Date</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e6eef8;">Groceries</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e6eef8;">Household Supplies</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e6eef8;">Personal</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e6eef8;">Total</th>
                        </tr>
                    </thead>
                    <tbody id="householdTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- TRAVEL CATEGORY -->
        <div id="travel" class="category-content">
            <h3>‚úàÔ∏è Travel Expenses</h3>
            <div style="margin-bottom: 20px;">
                <label for="travelMonth">Select Month: </label>
                <input type="month" id="travelMonth" style="padding: 10px; border-radius: 10px; border: 1px solid #e6eef8;" />
            </div>
            <input type="number" id="fuel" placeholder="Fuel" />
            <input type="number" id="taxi" placeholder="Taxi/Auto" />
            <input type="number" id="bus" placeholder="Bus/Train" />
            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; margin-bottom: 15px;">
              <button onclick="saveTravelData()">Save Data</button>
              <button id="toggleTravelTableBtn" onclick="toggleTravelTableVisibility()">Show Table</button>
              <button onclick="clearTravelData()" style="background: linear-gradient(90deg, #dc2626, #ef4444);">Clear All Data</button>
              <button onclick="toggleTravelMonthlyOptions()" style="background: linear-gradient(90deg, #f59e0b, #f97316);">Clear Monthly Data</button>
            </div>
            
            <!-- Travel Clear Monthly Data Section -->
            <div id="travelMonthlyOptions" style="display:none; margin-top:15px; padding:12px; background:rgba(255,255,255,0.05); border-radius:8px;">
              <div style="margin-bottom:10px;">
                <label>Select Month to Clear: </label>
                <input type="month" id="travelClearMonth" style="padding: 8px; border-radius: 6px; border: 1px solid #e6eef8;" />
              </div>
              <button onclick="clearTravelMonthlyData()" style="background: #dc2626; padding:8px 12px; border-radius:6px; border:none; color:white; cursor:pointer; margin-right:8px;">Delete Month Data</button>
              <button onclick="toggleTravelMonthlyOptions()" style="background: #64748b; padding:8px 12px; border-radius:6px; border:none; color:white; cursor:pointer;">Cancel</button>
            </div>
            
            <div id="travelSummary"></div>
            <div class="table-container" id="travelTableContainer" style="display: none;">
                <table class="expense-table" style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e6eef8;">Date</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e6eef8;">Fuel</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e6eef8;">Taxi/Auto</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e6eef8;">Bus/Train</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e6eef8;">Total</th>
                        </tr>
                    </thead>
                    <tbody id="travelTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- ENTERTAINMENT CATEGORY -->
        <div id="entertainment" class="category-content">
            <h3>üé¨ Entertainment Expenses</h3>
            <div style="margin-bottom: 20px;">
                <label for="entertainmentMonth">Select Month: </label>
                <input type="month" id="entertainmentMonth" style="padding: 10px; border-radius: 10px; border: 1px solid #e6eef8;" />
            </div>
            <input type="number" id="movies" placeholder="Movies" />
            <input type="number" id="drinks" placeholder="Drinks" />
            <input type="number" id="dining" placeholder="Dining Out" />
            <input type="number" id="subscriptions" placeholder="Subscriptions" />
            <input type="number" id="miscellaneous" placeholder="Miscellaneous" />
            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; margin-bottom: 15px;">
              <button onclick="saveEntertainmentData()">Save Data</button>
              <button id="toggleEntertainmentTableBtn" onclick="toggleEntertainmentTableVisibility()">Show Table</button>
              <button onclick="clearEntertainmentData()" style="background: linear-gradient(90deg, #dc2626, #ef4444);">Clear All Data</button>
              <button onclick="toggleEntertainmentMonthlyOptions()" style="background: linear-gradient(90deg, #f59e0b, #f97316);">Clear Monthly Data</button>
            </div>
            
            <!-- Entertainment Clear Monthly Data Section -->
            <div id="entertainmentMonthlyOptions" style="display:none; margin-top:15px; padding:12px; background:rgba(255,255,255,0.05); border-radius:8px;">
              <div style="margin-bottom:10px;">
                <label>Select Month to Clear: </label>
                <input type="month" id="entertainmentClearMonth" style="padding: 8px; border-radius: 6px; border: 1px solid #e6eef8;" />
              </div>
              <button onclick="clearEntertainmentMonthlyData()" style="background: #dc2626; padding:8px 12px; border-radius:6px; border:none; color:white; cursor:pointer; margin-right:8px;">Delete Month Data</button>
              <button onclick="toggleEntertainmentMonthlyOptions()" style="background: #64748b; padding:8px 12px; border-radius:6px; border:none; color:white; cursor:pointer;">Cancel</button>
            </div>
            
            <div id="entertainmentSummary"></div>
            <div class="table-container" id="entertainmentTableContainer" style="display: none;">
                <table class="expense-table" style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e6eef8;">Date</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e6eef8;">Movies</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e6eef8;">Drinks</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e6eef8;">Dining Out</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e6eef8;">Subscriptions</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e6eef8;">Miscellaneous</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e6eef8;">Total</th>
                        </tr>
                    </thead>
                    <tbody id="entertainmentTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- EMI CATEGORY -->
        <div id="emi" class="category-content">
            <h3>üí≥ EMI/Loans</h3>
            <div style="margin-bottom: 20px;">
                <label for="emiMonth">Select Month: </label>
                <input type="month" id="emiMonth" style="padding: 10px; border-radius: 10px; border: 1px solid #e6eef8;" />
            </div>
            <input type="number" id="carLoan" placeholder="Car Loan" />
            <input type="number" id="homeLoan" placeholder="Home Loan" />
            <input type="number" id="personalLoan" placeholder="Personal Loan" />
            <input type="number" id="otherLoans" placeholder="Other Loans" />
            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; margin-bottom: 15px;">
              <button onclick="saveEmiData()">Save Data</button>
              <button id="toggleEmiTableBtn" onclick="toggleEmiTableVisibility()">Show Table</button>
              <button onclick="clearEmiData()" style="background: linear-gradient(90deg, #dc2626, #ef4444);">Clear All Data</button>
              <button onclick="toggleEmiMonthlyOptions()" style="background: linear-gradient(90deg, #f59e0b, #f97316);">Clear Monthly Data</button>
            </div>
            
            <!-- EMI Clear Monthly Data Section -->
            <div id="emiMonthlyOptions" style="display:none; margin-top:15px; padding:12px; background:rgba(255,255,255,0.05); border-radius:8px;">
              <div style="margin-bottom:10px;">
                <label>Select Month to Clear: </label>
                <input type="month" id="emiClearMonth" style="padding: 8px; border-radius: 6px; border: 1px solid #e6eef8;" />
              </div>
              <button onclick="clearEmiMonthlyData()" style="background: #dc2626; padding:8px 12px; border-radius:6px; border:none; color:white; cursor:pointer; margin-right:8px;">Delete Month Data</button>
              <button onclick="toggleEmiMonthlyOptions()" style="background: #64748b; padding:8px 12px; border-radius:6px; border:none; color:white; cursor:pointer;">Cancel</button>
            </div>
            
            <div id="emiSummary"></div>
            <div class="table-container" id="emiTableContainer" style="display: none;">
                <table class="expense-table" style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e6eef8;">Date</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e6eef8;">Car Loan</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e6eef8;">Home Loan</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e6eef8;">Personal Loan</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e6eef8;">Other Loans</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e6eef8;">Total</th>
                        </tr>
                    </thead>
                    <tbody id="emiTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- VACATION CATEGORY -->
        <div id="vacation" class="category-content">
            <h3>üèñÔ∏è Vacation Expenses</h3>
            <div style="margin-bottom: 20px;">
                <label for="vacationMonth">Select Month: </label>
                <input type="month" id="vacationMonth" style="padding: 10px; border-radius: 10px; border: 1px solid #e6eef8;" />
            </div>
            <input type="number" id="accommodation" placeholder="Accommodation" />
            <input type="number" id="flights" placeholder="Flights / Train / Bus" />
            <input type="number" id="activities" placeholder="Activities" />
            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; margin-bottom: 15px;">
              <button onclick="saveVacationData()">Save Data</button>
              <button id="toggleVacationTableBtn" onclick="toggleVacationTableVisibility()">Show Table</button>
              <button onclick="clearVacationData()" style="background: linear-gradient(90deg, #dc2626, #ef4444);">Clear All Data</button>
              <button onclick="toggleVacationMonthlyOptions()" style="background: linear-gradient(90deg, #f59e0b, #f97316);">Clear Monthly Data</button>
            </div>
            
            <!-- Vacation Clear Monthly Data Section -->
            <div id="vacationMonthlyOptions" style="display:none; margin-top:15px; padding:12px; background:rgba(255,255,255,0.05); border-radius:8px;">
              <div style="margin-bottom:10px;">
                <label>Select Month to Clear: </label>
                <input type="month" id="vacationClearMonth" style="padding: 8px; border-radius: 6px; border: 1px solid #e6eef8;" />
              </div>
              <button onclick="clearVacationMonthlyData()" style="background: #dc2626; padding:8px 12px; border-radius:6px; border:none; color:white; cursor:pointer; margin-right:8px;">Delete Month Data</button>
              <button onclick="toggleVacationMonthlyOptions()" style="background: #64748b; padding:8px 12px; border-radius:6px; border:none; color:white; cursor:pointer;">Cancel</button>
            </div>
            
            <div id="vacationSummary"></div>
            <div class="table-container" id="vacationTableContainer" style="display: none;">
                <table class="expense-table" style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e6eef8;">Date</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e6eef8;">Accommodation</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e6eef8;">Flights / Train / Bus</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e6eef8;">Activities</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e6eef8;">Total</th>
                        </tr>
                    </thead>
                    <tbody id="vacationTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- FUTURE EXPENSES CATEGORY -->
        <div id="future" class="category-content">
            <h3>üìÖ Future Expenses</h3>
            <div style="max-width: 800px; margin: 0 auto;">
                <!-- Add Future Expense Form -->
                <div style="background: var(--card); padding: 24px; border-radius: 12px; box-shadow: var(--shadow); margin-bottom: 24px;">
                    <h4 style="margin-top: 0; color: var(--text);">Add New Future Expense</h4>
                    <form id="futureExpenseForm" onsubmit="addFutureExpense(event)">
                        <div style="display: grid; gap: 16px;">
                            <input type="text" id="expenseName" placeholder="Expense Name (e.g., New Laptop)" 
                                   pattern="[A-Za-z0-9\s]+" title="Please enter letters, numbers and spaces only" 
                                   required style="padding: 12px; border: 1px solid var(--card-border); border-radius: 8px; font-size: 14px; background: var(--card); color: var(--text);">
                            
                            <input type="number" id="expenseAmount" placeholder="Amount (‚Çπ)" 
                                   required min="1" step="0.01"
                                   style="padding: 12px; border: 1px solid var(--card-border); border-radius: 8px; font-size: 14px; background: var(--card); color: var(--text);">
                            
                            <input type="date" id="expenseDate" required 
                                   style="padding: 12px; border: 1px solid var(--card-border); border-radius: 8px; font-size: 14px; background: var(--card); color: var(--text);">
                            
                            <textarea id="expenseNotes" placeholder="Notes (optional)" rows="3"
                                      style="padding: 12px; border: 1px solid var(--card-border); border-radius: 8px; font-size: 14px; resize: vertical; background: var(--card); color: var(--text);"></textarea>
                            
                            <button type="submit" style="background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; padding: 14px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.2s;">
                                ‚ûï Add Future Expense
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Action Buttons -->
                <div style="display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap;">
                    <button onclick="showAllExpenses()" id="toggleBtn" 
                            style="background: var(--primary); color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">
                        üìã Show All Future Expenses
                    </button>
                    <button onclick="deleteAllExpenses()" 
                            style="background: linear-gradient(90deg, #dc2626, #ef4444); color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">
                        üóëÔ∏è Delete All Future Expenses
                    </button>
                </div>

                <!-- Future Expenses List -->
                <div id="futureExpensesContainer" style="display: none;">
                    <div style="background: var(--card); padding: 24px; border-radius: 12px; box-shadow: var(--shadow);">
                        <h4 style="margin-top: 0; color: var(--text);">Your Future Expenses</h4>
                        <div id="futureExpensesList"></div>
                    </div>
                </div>

                <!-- Statistics -->
                <div id="statsContainer" style="display: none; margin-top: 24px;">
                    <div style="background: var(--card); padding: 24px; border-radius: 12px; box-shadow: var(--shadow);">
                        <h4 style="margin-top: 0; color: var(--text);">Summary</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                            <div style="text-align: center; padding: 16px; background: linear-gradient(135deg, rgba(37,99,235,0.1), rgba(14,165,164,0.1)); border-radius: 8px;">
                                <div style="font-size: 24px; font-weight: 700; color: var(--primary);" id="totalCount">0</div>
                                <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">Total Expenses</div>
                            </div>
                            <div style="text-align: center; padding: 16px; background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(5,150,105,0.1)); border-radius: 8px;">
                                <div style="font-size: 24px; font-weight: 700; color: var(--accent);" id="totalAmount">‚Çπ0</div>
                                <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">Total Amount</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            All your expenses in one place. Stay on top of your finances with ExpenseWise<br>
            <a href="about.html">üìä About</a> | 
            <a href="contact.html">üìß Contact</a>
        </footer>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // Theme initialization
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeButton();
        }

        function updateThemeButton() {
            const btn = document.querySelector('.theme-toggle');
            const current = document.documentElement.getAttribute('data-theme');
            if (btn) {
                btn.textContent = current === 'dark' ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode';
            }
        }

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const newTheme = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeButton();
        }

        // Category switching
        function switchCategory(category, el) {
            // Hide all categories
            document.querySelectorAll('.category-content').forEach(el => {
                el.classList.remove('active');
            });
            
            // Remove active from all tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected category
            document.getElementById(category).classList.add('active');
            
            // Mark tab as active using explicit element (avoid global event)
            if (el) {
                el.classList.add('active');
            } else {
                // Fallback: find tab by text if invoked programmatically
                const match = Array.from(document.querySelectorAll('.tab-btn')).find(btn => btn.textContent.toLowerCase().includes(category));
                if (match) match.classList.add('active');
            }
            
            // Initialize Future Expenses if switching to it
            if (category === 'future') {
                if (typeof FutureExpensesManager !== 'undefined') {
                    FutureExpensesManager.init();
                }
            }
            
            // Set month input if not already set
            const monthInput = document.getElementById(category + 'Month');
            if (monthInput && !monthInput.value) {
                const today = new Date();
                const month = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0');
                monthInput.value = month;
            }
        }

        // Initialize theme on page load
        window.addEventListener('load', async function() {
            initTheme();
            
            // Wait for Firebase auth to initialize
            const statusBox = document.getElementById('userStatusBox');
            statusBox.innerHTML = '‚è≥ Checking auth...';
            
            if (window.firebaseAuth) {
                try {
                    // Wait for auth initialization if available
                    if (typeof initFirebaseAuth !== 'undefined') {
                        await initFirebaseAuth();
                    }
                    
                    // Monitor auth state changes
                    window.firebaseAuth.onAuthStateChanged(function(user) {
                        if (user) {
                            statusBox.style.color = '#10b981';
                            statusBox.style.borderColor = '#10b981';
                            const email = user.email.length > 25 ? user.email.substring(0, 22) + '...' : user.email;
                            statusBox.innerHTML = `üîµ ${email}`;
                            console.log('‚úÖ User signed in:', user.email, 'UID:', user.uid);
                        } else {
                            statusBox.style.color = '#f59e0b';
                            statusBox.style.borderColor = 'rgba(255,255,255,0.2)';
                            statusBox.innerHTML = 'üë§ Guest Mode';
                            statusBox.title = 'Sign in on Home page for data isolation';
                            console.log('‚ö†Ô∏è No user signed in - Guest mode');
                        }
                    });
                } catch (error) {
                    console.error('Auth initialization error:', error);
                    statusBox.style.color = '#dc2626';
                    statusBox.innerHTML = '‚ùå Auth Error';
                }
            } else {
                statusBox.style.color = '#dc2626';
                statusBox.innerHTML = '‚ùå Firebase Not Available';
            }
            
            // Set current month for all categories
            const today = new Date();
            const month = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0');
            
            document.getElementById('householdMonth').value = month;
            document.getElementById('travelMonth').value = month;
            document.getElementById('entertainmentMonth').value = month;
            document.getElementById('emiMonth').value = month;
            document.getElementById('vacationMonth').value = month;
            
            // Handle URL hash navigation (e.g., categories.html#future)
            const hash = window.location.hash.substring(1);
            if (hash && ['household', 'travel', 'entertainment', 'emi', 'vacation', 'future'].includes(hash)) {
                // Find and click the correct tab
                const tabs = document.querySelectorAll('.tab-btn');
                tabs.forEach(tab => {
                    if (tab.textContent.toLowerCase().includes(hash === 'future' ? 'future' : hash)) {
                        tab.click();
                    }
                });
            }
        });

        // Shared helper to fetch expense data from Firebase (via ExpenseService) or localStorage
        async function fetchExpenseData(type, month) {
            if (!month) return null;

            // Try Firebase/local via ExpenseService first
            if (typeof ExpenseService !== 'undefined' && ExpenseService.load) {
                try {
                    const remote = await ExpenseService.load(type, month);
                    if (remote) return remote;
                } catch (error) {
                    console.error('ExpenseService load error:', error);
                }
            }

            // Fallback to localStorage keys (new + legacy)
            try {
                const userId = getCurrentUserId ? getCurrentUserId() : 'guest_' + Date.now();
                const primaryKey = `expense_${userId}_${type}_${month}`;
                const legacyKey = `EXPENSE_USER_${userId}_${type.toUpperCase()}_${month}`;
                const raw = localStorage.getItem(primaryKey) || localStorage.getItem(legacyKey);
                return raw ? JSON.parse(raw) : null;
            } catch (error) {
                console.error('Local load error:', error);
                return null;
            }
        }

        // Fetch all expense entries (all months) from localStorage (and ExpenseService local key format)
        async function fetchAllExpenseData(type) {
            const userId = getCurrentUserId ? getCurrentUserId() : 'guest_' + Date.now();
            const isAuthenticated = typeof isUserAuthenticated !== 'undefined' ? isUserAuthenticated() : false;
            const entries = new Map();

            // RULE 1: Authenticated users MUST load from Firebase
            if (isAuthenticated && typeof window.firebaseDB !== 'undefined') {
                try {
                    const ref = window.firebaseDB.ref(`users/${userId}/expenses/${type}`);
                    const snapshot = await ref.once('value');
                    const firebaseData = snapshot.val();
                    
                    if (firebaseData) {
                        // firebaseData is organized as: { month1: {...}, month2: {...}, ... }
                        Object.keys(firebaseData).forEach(month => {
                            if (firebaseData[month]) {
                                entries.set(month, { ...firebaseData[month], date: month });
                            }
                        });
                        console.log(`‚úÖ Loaded ${entries.size} months from Firebase for ${type}`);
                    } else {
                        console.log(`‚ö†Ô∏è No Firebase data found for ${type}`);
                    }
                } catch (error) {
                    console.error(`‚ùå Failed to load ${type} from Firebase:`, error);
                    // Don't fallback - authenticated users must use Firebase
                    return [];
                }
                return Array.from(entries.values()).sort((a, b) => new Date(b.date) - new Date(a.date));
            }

            // RULE 2: Guest users use localStorage only
            const primaryPrefix = `expense_${userId}_${type}_`;
            const legacyPrefix = `EXPENSE_USER_${userId}_${type.toUpperCase()}_`;

            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (!key) continue;

                if (key.startsWith(primaryPrefix)) {
                    const month = key.replace(primaryPrefix, '');
                    const data = JSON.parse(localStorage.getItem(key) || 'null');
                    if (data) entries.set(month, { ...data, date: month });
                } else if (key.startsWith(legacyPrefix)) {
                    const month = key.replace(legacyPrefix, '');
                    const data = JSON.parse(localStorage.getItem(key) || 'null');
                    if (data && !entries.has(month)) entries.set(month, { ...data, date: month });
                }
            }

            return Array.from(entries.values()).sort((a, b) => new Date(b.date) - new Date(a.date));
        }

        // Remove local data for a given type (all months)
        function removeLocalExpenses(type) {
            const userId = getCurrentUserId ? getCurrentUserId() : 'guest_' + Date.now();
            const prefixes = [
                `expense_${userId}_${type}_`,
                `EXPENSE_USER_${userId}_${type.toUpperCase()}_`
            ];

            const keysToDelete = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (!key) continue;
                if (prefixes.some(prefix => key.startsWith(prefix))) {
                    keysToDelete.push(key);
                }
            }

            keysToDelete.forEach(key => localStorage.removeItem(key));
        }

        // ============= FOOD FUNCTIONS =============
        async function saveHouseholdData() {
            const groceries = parseFloat(document.getElementById('groceries').value) || 0;
            const householdSupplies = parseFloat(document.getElementById('householdSupplies').value) || 0;
            const personal = parseFloat(document.getElementById('personal').value) || 0;
            const month = document.getElementById('householdMonth').value;
            const total = groceries + householdSupplies + personal;

            if (!month) {
                console.log('Please select a month');
                return;
            }

            if (total === 0) {
                console.log('Please enter at least one expense value');
                return;
            }

            try {
                const expenseData = { groceries, householdSupplies, personal, total, date: month };
                
                // Use ExpenseService if available
                if (typeof ExpenseService !== 'undefined' && ExpenseService.save) {
                    await ExpenseService.save('household', month, expenseData);
                } else {
                    // Fallback to localStorage (aligned with ExpenseService.saveLocal keying)
                    const userId = getCurrentUserId ? getCurrentUserId() : 'guest_' + Date.now();
                    const key = `expense_${userId}_household_${month}`;
                    localStorage.setItem(key, JSON.stringify(expenseData));
                }
                
                document.getElementById('householdSummary').innerHTML = `<p><strong>${month}</strong> - Total: ‚Çπ${total}</p>`;
                document.getElementById('groceries').value = '';
                document.getElementById('householdSupplies').value = '';
                document.getElementById('personal').value = '';
                console.log('‚úì Household expenses saved');
                loadHouseholdTable(); // Refresh table
            } catch (error) {
                console.error('Error saving household data:', error);
                console.log('Error saving data. Please try again.');
            }
        }

        async function loadHouseholdTable() {
            const tbody = document.getElementById('householdTableBody');
            tbody.innerHTML = '';
            
            try {
                const rows = await fetchAllExpenseData('household');
                if (rows.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:10px;">No data saved yet</td></tr>';
                    return;
                }
                rows.forEach((data) => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td style="padding: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">${data.date}</td>
                        <td style="padding: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">‚Çπ${data.groceries || 0}</td>
                        <td style="padding: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">‚Çπ${data.householdSupplies || 0}</td>
                        <td style="padding: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">‚Çπ${data.personal || 0}</td>
                        <td style="padding: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); font-weight: bold;">‚Çπ${data.total || 0}</td>
                    `;
                });
            } catch (error) {
                console.error('Error loading household table:', error);
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:10px;">Error loading data</td></tr>';
            }
        }

        async function clearHouseholdData() {
            try {
                await ExpenseService.clearAll('household');
                console.log('‚úì All household data cleared');
                document.getElementById('householdTableContainer').style.display = 'none';
                document.getElementById('householdTableBody').innerHTML = '';
            } catch (error) {
                console.error('Error clearing household data:', error);
                console.log('Error clearing data');
            }
        }

        async function toggleHouseholdTableVisibility() {
            const container = document.getElementById('householdTableContainer');
            if (container.style.display === 'none') {
                await loadHouseholdTable();
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        }

        // ============= TRAVEL FUNCTIONS =============
        async function saveTravelData() {
            const fuel = parseFloat(document.getElementById('fuel').value) || 0;
            const taxi = parseFloat(document.getElementById('taxi').value) || 0;
            const bus = parseFloat(document.getElementById('bus').value) || 0;
            const month = document.getElementById('travelMonth').value;
            const total = fuel + taxi + bus;

            if (!month) {
                console.log('Please select a month');
                return;
            }

            if (total === 0) {
                console.log('Please enter at least one expense value');
                return;
            }

            try {
                const expenseData = { fuel, taxi, bus, total, date: month };
                
                if (typeof ExpenseService !== 'undefined' && ExpenseService.save) {
                    await ExpenseService.save('travel', month, expenseData);
                } else {
                    const userId = getCurrentUserId ? getCurrentUserId() : 'guest_' + Date.now();
                    const key = `expense_${userId}_travel_${month}`;
                    localStorage.setItem(key, JSON.stringify(expenseData));
                }
                
                document.getElementById('travelSummary').innerHTML = `<p><strong>${month}</strong> - Total: ‚Çπ${total}</p>`;
                document.getElementById('fuel').value = '';
                document.getElementById('taxi').value = '';
                document.getElementById('bus').value = '';
                console.log('‚úì Travel expenses saved');
                loadTravelTable();
            } catch (error) {
                console.error('Error saving travel data:', error);
                console.log('Error saving data. Please try again.');
            }
        }

        async function loadTravelTable() {
            const tbody = document.getElementById('travelTableBody');
            tbody.innerHTML = '';
            
            try {
                const rows = await fetchAllExpenseData('travel');
                if (rows.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:10px;">No data saved yet</td></tr>';
                    return;
                }
                rows.forEach((data) => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td style="padding: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">${data.date}</td>
                        <td style="padding: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">‚Çπ${data.fuel || 0}</td>
                        <td style="padding: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">‚Çπ${data.taxi || 0}</td>
                        <td style="padding: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">‚Çπ${data.bus || 0}</td>
                        <td style="padding: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); font-weight: bold;">‚Çπ${data.total || 0}</td>
                    `;
                });
            } catch (error) {
                console.error('Error loading travel table:', error);
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:10px;">Error loading data</td></tr>';
            }
        }

        async function clearTravelData() {
            try {
                await ExpenseService.clearAll('travel');
                console.log('‚úì All travel data cleared');
                document.getElementById('travelTableContainer').style.display = 'none';
                document.getElementById('travelTableBody').innerHTML = '';
            } catch (error) {
                console.error('Error clearing travel data:', error);
                console.log('Error clearing data');
            }
        }

        async function toggleTravelTableVisibility() {
            const container = document.getElementById('travelTableContainer');
            if (container.style.display === 'none') {
                await loadTravelTable();
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        }

        // ============= ENTERTAINMENT FUNCTIONS =============
        async function saveEntertainmentData() {
            const movies = parseFloat(document.getElementById('movies').value) || 0;
            const drinks = parseFloat(document.getElementById('drinks').value) || 0;
            const dining = parseFloat(document.getElementById('dining').value) || 0;
            const subscriptions = parseFloat(document.getElementById('subscriptions').value) || 0;
            const miscellaneous = parseFloat(document.getElementById('miscellaneous').value) || 0;
            const month = document.getElementById('entertainmentMonth').value;
            const total = movies + drinks + dining + subscriptions + miscellaneous;

            if (!month) {
                console.log('Please select a month');
                return;
            }

            if (total === 0) {
                console.log('Please enter at least one expense value');
                return;
            }

            try {
                const expenseData = { movies, drinks, dining, subscriptions, miscellaneous, total, date: month };
                
                if (typeof ExpenseService !== 'undefined' && ExpenseService.save) {
                    await ExpenseService.save('entertainment', month, expenseData);
                } else {
                    const userId = getCurrentUserId ? getCurrentUserId() : 'guest_' + Date.now();
                    const key = `expense_${userId}_entertainment_${month}`;
                    localStorage.setItem(key, JSON.stringify(expenseData));
                }
                
                document.getElementById('entertainmentSummary').innerHTML = `<p><strong>${month}</strong> - Total: ‚Çπ${total}</p>`;
                document.getElementById('movies').value = '';
                document.getElementById('drinks').value = '';
                document.getElementById('dining').value = '';
                document.getElementById('subscriptions').value = '';
                document.getElementById('miscellaneous').value = '';
                console.log('‚úì Entertainment expenses saved');
                loadEntertainmentTable();
            } catch (error) {
                console.error('Error saving entertainment data:', error);
                console.log('Error saving data. Please try again.');
            }
        }

        async function clearEntertainmentData() {
            try {
                await ExpenseService.clearAll('entertainment');
                console.log('‚úì All entertainment data cleared');
                document.getElementById('entertainmentTableContainer').style.display = 'none';
                document.getElementById('entertainmentTableBody').innerHTML = '';
                document.getElementById('movies').value = '';
                document.getElementById('drinks').value = '';
                document.getElementById('dining').value = '';
                document.getElementById('subscriptions').value = '';
                document.getElementById('miscellaneous').value = '';
            } catch (error) {
                console.error('Error clearing entertainment data:', error);
                console.log('Error clearing data');
            }
        }

        async function loadEntertainmentTable() {
            const tbody = document.getElementById('entertainmentTableBody');
            tbody.innerHTML = '';
            
            try {
                const rows = await fetchAllExpenseData('entertainment');
                if (rows.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:10px;">No data saved yet</td></tr>';
                    return;
                }
                rows.forEach((data) => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td style="padding: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">${data.date}</td>
                        <td style="padding: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">‚Çπ${data.movies || 0}</td>
                        <td style="padding: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">‚Çπ${data.drinks || 0}</td>
                        <td style="padding: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">‚Çπ${data.dining || 0}</td>
                        <td style="padding: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">‚Çπ${data.subscriptions || 0}</td>
                        <td style="padding: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">‚Çπ${data.miscellaneous || 0}</td>
                        <td style="padding: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); font-weight: bold;">‚Çπ${data.total || 0}</td>
                    `;
                });
            } catch (error) {
                console.error('Error loading entertainment table:', error);
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:10px;">Error loading data</td></tr>';
            }
        }

        async function toggleEntertainmentTableVisibility() {
            const container = document.getElementById('entertainmentTableContainer');
            if (container.style.display === 'none') {
                await loadEntertainmentTable();
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        }

        // ============= EMI FUNCTIONS =============
        async function saveEmiData() {
            const carLoan = parseFloat(document.getElementById('carLoan').value) || 0;
            const homeLoan = parseFloat(document.getElementById('homeLoan').value) || 0;
            const personalLoan = parseFloat(document.getElementById('personalLoan').value) || 0;
            const otherLoans = parseFloat(document.getElementById('otherLoans').value) || 0;
            const month = document.getElementById('emiMonth').value;
            const total = carLoan + homeLoan + personalLoan + otherLoans;

            if (!month) {
                console.log('Please select a month');
                return;
            }

            if (total === 0) {
                console.log('Please enter at least one expense value');
                return;
            }

            try {
                const expenseData = { carLoan, homeLoan, personalLoan, otherLoans, total, date: month };
                
                if (typeof ExpenseService !== 'undefined' && ExpenseService.save) {
                    await ExpenseService.save('emi', month, expenseData);
                } else {
                    const userId = getCurrentUserId ? getCurrentUserId() : 'guest_' + Date.now();
                    const key = `expense_${userId}_emi_${month}`;
                    localStorage.setItem(key, JSON.stringify(expenseData));
                }
                
                document.getElementById('emiSummary').innerHTML = `<p><strong>${month}</strong> - Total: ‚Çπ${total}</p>`;
                document.getElementById('carLoan').value = '';
                document.getElementById('homeLoan').value = '';
                document.getElementById('personalLoan').value = '';
                document.getElementById('otherLoans').value = '';
                console.log('‚úì EMI data saved');
                loadEmiTable();
            } catch (error) {
                console.error('Error saving EMI data:', error);
                console.log('Error saving data. Please try again.');
            }
        }


        async function clearEmiData() {
            try {
                await ExpenseService.clearAll('emi');
                console.log('‚úì All EMI data cleared');
                document.getElementById('emiTableContainer').style.display = 'none';
                document.getElementById('emiTableBody').innerHTML = '';
                document.getElementById('carLoan').value = '';
                document.getElementById('homeLoan').value = '';
                document.getElementById('personalLoan').value = '';
                document.getElementById('otherLoans').value = '';
            } catch (error) {
                console.error('Error clearing EMI data:', error);
                console.log('Error clearing data');
            }
        }

        async function loadEmiTable() {
            const tbody = document.getElementById('emiTableBody');
            tbody.innerHTML = '';
            
            try {
                const rows = await fetchAllExpenseData('emi');
                if (rows.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:10px;">No data saved yet</td></tr>';
                    return;
                }
                rows.forEach((data) => {
                    const otherVal = data ? (data.otherLoans || 0) : 0;
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td style="padding: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">${data.date}</td>
                        <td style="padding: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">‚Çπ${data.carLoan || 0}</td>
                        <td style="padding: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">‚Çπ${data.homeLoan || 0}</td>
                        <td style="padding: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">‚Çπ${data.personalLoan || 0}</td>
                        <td style="padding: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">‚Çπ${otherVal}</td>
                        <td style="padding: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); font-weight: bold;">‚Çπ${data.total || 0}</td>
                    `;
                });
            } catch (error) {
                console.error('Error loading EMI table:', error);
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:10px;">Error loading data</td></tr>';
            }
        }

        async function toggleEmiTableVisibility() {
            const container = document.getElementById('emiTableContainer');
            if (container.style.display === 'none') {
                await loadEmiTable();
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        }

        // ============= VACATION FUNCTIONS =============
        async function saveVacationData() {
            const accommodation = parseFloat(document.getElementById('accommodation').value) || 0;
            const flights = parseFloat(document.getElementById('flights').value) || 0;
            const activities = parseFloat(document.getElementById('activities').value) || 0;
            const month = document.getElementById('vacationMonth').value;
            const total = accommodation + flights + activities;

            if (!month) {
                console.log('Please select a month');
                return;
            }

            if (total === 0) {
                console.log('Please enter at least one expense value');
                return;
            }

            try {
                const expenseData = { accommodation, flights, activities, total, date: month };
                
                if (typeof ExpenseService !== 'undefined' && ExpenseService.save) {
                    await ExpenseService.save('vacation', month, expenseData);
                } else {
                    const userId = getCurrentUserId ? getCurrentUserId() : 'guest_' + Date.now();
                    const key = `expense_${userId}_vacation_${month}`;
                    localStorage.setItem(key, JSON.stringify(expenseData));
                }
                
                document.getElementById('vacationSummary').innerHTML = `<p><strong>${month}</strong> - Total: ‚Çπ${total}</p>`;
                document.getElementById('accommodation').value = '';
                document.getElementById('flights').value = '';
                document.getElementById('activities').value = '';
                console.log('‚úì Vacation expenses saved');
                loadVacationTable();
            } catch (error) {
                console.error('Error saving vacation data:', error);
                console.log('Error saving data. Please try again.');
            }
        }

        async function clearVacationData() {
            try {
                await ExpenseService.clearAll('vacation');
                console.log('‚úì All vacation data cleared');
                document.getElementById('vacationTableContainer').style.display = 'none';
                document.getElementById('vacationTableBody').innerHTML = '';
            } catch (error) {
                console.error('Error clearing vacation data:', error);
                console.log('Error clearing data');
            }
        }

        async function loadVacationTable() {
            const tbody = document.getElementById('vacationTableBody');
            tbody.innerHTML = '';
            
            try {
                const rows = await fetchAllExpenseData('vacation');
                if (rows.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:10px;">No data saved yet</td></tr>';
                    return;
                }

                rows.forEach((data) => {
                    const flightsVal = data.flights ?? data.travel ?? 0; // fallback for older keys
                    const activitiesVal = data.activities ?? data.food ?? data.transport ?? 0; // fallback
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td style="padding: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">${data.date}</td>
                        <td style="padding: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">‚Çπ${data.accommodation || 0}</td>
                        <td style="padding: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">‚Çπ${flightsVal}</td>
                        <td style="padding: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">‚Çπ${activitiesVal}</td>
                        <td style="padding: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); font-weight: bold;">‚Çπ${data.total || 0}</td>
                    `;
                });
            } catch (error) {
                console.error('Error loading Vacation table:', error);
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:10px;">Error loading data</td></tr>';
            }
        }

        async function toggleVacationTableVisibility() {
            const container = document.getElementById('vacationTableContainer');
            if (container.style.display === 'none') {
                await loadVacationTable();
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        }

        // ============= CLEAR MONTHLY DATA FUNCTIONS =============
        // HOUSEHOLD
        function toggleHouseholdMonthlyOptions() {
            const div = document.getElementById('householdMonthlyOptions');
            div.style.display = div.style.display === 'none' ? 'block' : 'none';
        }

        async function clearHouseholdMonthlyData() {
            const monthSelector = document.getElementById('householdClearMonth');
            const selectedMonth = monthSelector.value;
            
            if (!selectedMonth) {
                console.log('Please select a month to clear');
                return;
            }
            
            try {
                const userId = getCurrentUserId();
                const prefix = `expense_${userId}_household_`;
                let deletedCount = 0;
                
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith(prefix) && key.includes(selectedMonth)) {
                        localStorage.removeItem(key);
                        deletedCount++;
                    }
                }
                
                console.log(`‚úì Cleared ${deletedCount} household entries for ${selectedMonth}`);
                toggleHouseholdMonthlyOptions();
                loadHouseholdTable();
            } catch (error) {
                console.error('Error clearing monthly data:', error);
                console.log('Error clearing data');
            }
        }

        // TRAVEL
        function toggleTravelMonthlyOptions() {
            const div = document.getElementById('travelMonthlyOptions');
            div.style.display = div.style.display === 'none' ? 'block' : 'none';
        }

        async function clearTravelMonthlyData() {
            const monthSelector = document.getElementById('travelClearMonth');
            const selectedMonth = monthSelector.value;
            
            if (!selectedMonth) {
                console.log('Please select a month to clear');
                return;
            }
            
            try {
                const userId = getCurrentUserId();
                const prefix = `expense_${userId}_travel_`;
                let deletedCount = 0;
                
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith(prefix) && key.includes(selectedMonth)) {
                        localStorage.removeItem(key);
                        deletedCount++;
                    }
                }
                
                console.log(`‚úì Cleared ${deletedCount} travel entries for ${selectedMonth}`);
                toggleTravelMonthlyOptions();
                loadTravelTable();
            } catch (error) {
                console.error('Error clearing monthly data:', error);
                console.log('Error clearing data');
            }
        }

        // ENTERTAINMENT
        function toggleEntertainmentMonthlyOptions() {
            const div = document.getElementById('entertainmentMonthlyOptions');
            div.style.display = div.style.display === 'none' ? 'block' : 'none';
        }

        async function clearEntertainmentMonthlyData() {
            const monthSelector = document.getElementById('entertainmentClearMonth');
            const selectedMonth = monthSelector.value;
            
            if (!selectedMonth) {
                console.log('Please select a month to clear');
                return;
            }
            
            try {
                const userId = getCurrentUserId();
                const prefix = `expense_${userId}_entertainment_`;
                let deletedCount = 0;
                
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith(prefix) && key.includes(selectedMonth)) {
                        localStorage.removeItem(key);
                        deletedCount++;
                    }
                }
                
                console.log(`‚úì Cleared ${deletedCount} entertainment entries for ${selectedMonth}`);
                toggleEntertainmentMonthlyOptions();
                loadEntertainmentTable();
            } catch (error) {
                console.error('Error clearing monthly data:', error);
                console.log('Error clearing data');
            }
        }

        // EMI
        function toggleEmiMonthlyOptions() {
            const div = document.getElementById('emiMonthlyOptions');
            div.style.display = div.style.display === 'none' ? 'block' : 'none';
        }

        async function clearEmiMonthlyData() {
            const monthSelector = document.getElementById('emiClearMonth');
            const selectedMonth = monthSelector.value;
            
            if (!selectedMonth) {
                console.log('Please select a month to clear');
                return;
            }
            
            try {
                const userId = getCurrentUserId();
                const prefix = `expense_${userId}_emi_`;
                let deletedCount = 0;
                
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith(prefix) && key.includes(selectedMonth)) {
                        localStorage.removeItem(key);
                        deletedCount++;
                    }
                }
                
                console.log(`‚úì Cleared ${deletedCount} EMI entries for ${selectedMonth}`);
                toggleEmiMonthlyOptions();
                loadEmiTable();
            } catch (error) {
                console.error('Error clearing monthly data:', error);
                console.log('Error clearing data');
            }
        }

        // VACATION
        function toggleVacationMonthlyOptions() {
            const div = document.getElementById('vacationMonthlyOptions');
            div.style.display = div.style.display === 'none' ? 'block' : 'none';
        }

        async function clearVacationMonthlyData() {
            const monthSelector = document.getElementById('vacationClearMonth');
            const selectedMonth = monthSelector.value;
            
            if (!selectedMonth) {
                console.log('Please select a month to clear');
                return;
            }
            
            try {
                const userId = getCurrentUserId();
                const prefix = `expense_${userId}_vacation_`;
                let deletedCount = 0;
                
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith(prefix) && key.includes(selectedMonth)) {
                        localStorage.removeItem(key);
                        deletedCount++;
                    }
                }
                
                console.log(`‚úì Cleared ${deletedCount} vacation entries for ${selectedMonth}`);
                toggleVacationMonthlyOptions();
                loadVacationTable();
            } catch (error) {
                console.error('Error clearing monthly data:', error);
                console.log('Error clearing data');
            }
        }

        // ============= FUTURE EXPENSES FUNCTIONS =============
        function getCurrentUserId() {
            if (typeof firebase !== 'undefined' && firebase.auth && firebase.auth().currentUser) {
                return firebase.auth().currentUser.uid;
            }
            // Ensure consistent guest ID
            let guestId = localStorage.getItem('guestUserId');
            if (!guestId) {
                guestId = 'guest_' + Date.now();
                localStorage.setItem('guestUserId', guestId);
            }
            return guestId;
        }

        function addFutureExpense(event) {
            event.preventDefault();
            
            const name = document.getElementById('expenseName').value.trim();
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const date = document.getElementById('expenseDate').value;
            const notes = document.getElementById('expenseNotes').value.trim();

            if (!name || !amount || !date) {
                console.log('Please fill in all required fields');
                return;
            }

            const expense = {
                id: Date.now(),
                name,
                amount,
                date,
                notes,
                createdAt: new Date().toISOString()
            };

            try {
                const userId = getCurrentUserId();
                const storageKey = `futureExpenses_${userId}`;
                const expenses = JSON.parse(localStorage.getItem(storageKey) || '[]');
                expenses.push(expense);
                localStorage.setItem(storageKey, JSON.stringify(expenses));

                // Clear form
                document.getElementById('futureExpenseForm').reset();
                
                console.log('‚úì Future expense added successfully!');
                
                // Auto-show the expenses list and summary
                document.getElementById('futureExpensesContainer').style.display = 'block';
                document.getElementById('statsContainer').style.display = 'block';
                document.getElementById('toggleBtn').textContent = 'üîº Hide Future Expenses';
                loadFutureExpenses();
            } catch (error) {
                console.error('Error adding future expense:', error);
                console.log('Error saving expense. Please try again.');
            }
        }

        function showAllExpenses() {
            const container = document.getElementById('futureExpensesContainer');
            const statsContainer = document.getElementById('statsContainer');
            const toggleBtn = document.getElementById('toggleBtn');

            if (container.style.display === 'none') {
                loadFutureExpenses();
                container.style.display = 'block';
                statsContainer.style.display = 'block';
                toggleBtn.textContent = 'üîº Hide Future Expenses';
            } else {
                container.style.display = 'none';
                statsContainer.style.display = 'none';
                toggleBtn.textContent = 'üìã Show All Future Expenses';
            }
        }

        function loadFutureExpenses() {
            const userId = getCurrentUserId();
            const storageKey = `futureExpenses_${userId}`;
            const expenses = JSON.parse(localStorage.getItem(storageKey) || '[]');
            
            const listContainer = document.getElementById('futureExpensesList');
            
            if (expenses.length === 0) {
                listContainer.innerHTML = '<p style="text-align: center; color: var(--muted); padding: 20px;">No future expenses added yet.</p>';
                document.getElementById('totalCount').textContent = '0';
                document.getElementById('totalAmount').textContent = '‚Çπ0';
                return;
            }

            // Sort by date
            expenses.sort((a, b) => new Date(a.date) - new Date(b.date));

            let html = '';
            let totalAmount = 0;

            expenses.forEach(expense => {
                totalAmount += expense.amount;
                const formattedDate = new Date(expense.date).toLocaleDateString('en-IN', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });

                html += `
                    <div style="background: rgba(0, 0, 0, 0.2); padding: 16px; border-radius: 8px; margin-bottom: 12px; border: 1px solid rgba(255, 255, 255, 0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <div>
                                <h5 style="margin: 0 0 4px 0; color: var(--text); font-size: 16px; font-weight: 600;">${expense.name}</h5>
                                <p style="margin: 0; color: var(--muted); font-size: 13px;">üìÖ ${formattedDate}</p>
                            </div>
                            <div style="text-align: right;">
                                <p style="margin: 0 0 8px 0; color: var(--accent); font-size: 18px; font-weight: 700;">‚Çπ${expense.amount.toLocaleString('en-IN')}</p>
                                <button onclick="deleteFutureExpense(${expense.id})" 
                                        style="background: #dc2626; padding: 6px 12px; font-size: 12px; border-radius: 6px;">
                                    üóëÔ∏è Delete
                                </button>
                            </div>
                        </div>
                        ${expense.notes ? `<p style="margin: 8px 0 0 0; color: var(--muted); font-size: 13px; font-style: italic;">üìù ${expense.notes}</p>` : ''}
                    </div>
                `;
            });

            listContainer.innerHTML = html;
            document.getElementById('totalCount').textContent = expenses.length;
            document.getElementById('totalAmount').textContent = '‚Çπ' + totalAmount.toLocaleString('en-IN');
        }

        function deleteFutureExpense(id) {
            if (!confirm('Delete this future expense?')) return;

            try {
                const userId = getCurrentUserId();
                const storageKey = `futureExpenses_${userId}`;
                let expenses = JSON.parse(localStorage.getItem(storageKey) || '[]');
                expenses = expenses.filter(exp => exp.id !== id);
                localStorage.setItem(storageKey, JSON.stringify(expenses));
                
                loadFutureExpenses();
                console.log('‚úì Expense deleted');
            } catch (error) {
                console.error('Error deleting expense:', error);
                console.log('Error deleting expense');
            }
        }

        function deleteAllExpenses() {
            if (!confirm('Delete ALL future expenses? This cannot be undone!')) return;

            try {
                const userId = getCurrentUserId();
                const storageKey = `futureExpenses_${userId}`;
                localStorage.removeItem(storageKey);
                
                document.getElementById('futureExpensesContainer').style.display = 'none';
                document.getElementById('statsContainer').style.display = 'none';
                document.getElementById('toggleBtn').textContent = 'üìã Show All Future Expenses';
                
                console.log('‚úì All future expenses deleted');
            } catch (error) {
                console.error('Error deleting all expenses:', error);
                console.log('Error deleting expenses');
            }
        }
    </script>
</body>
</html>
