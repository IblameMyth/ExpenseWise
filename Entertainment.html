<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entertainment</title>
    <link rel="stylesheet" href="styles.css">
    <script src="auth.js"></script>
    <style>
        :root{
            --bg:#f8fafc;
            --card:rgba(255, 255, 255, 0.9);
            --muted:#6b7280;
            --text:#0f172a;
            --primary:#2563eb;
            --accent:#0ea5a4;
            --radius:12px;
            --shadow:0 8px 26px rgba(15,23,42,0.06);
            --container:1100px;
            --bg-img:url('https://images.unsplash.com/photo-1542223616-1e7b2d2b02d9?auto=format&fit=crop&w=1500&q=80');
            --glass-bg: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
            --glass-border: 1px solid rgba(255, 255, 255, 0.2);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        /* Dark mode variables */
        [data-theme="dark"] {
            --bg: #0f172a;
            --card: rgba(30, 41, 59, 0.9);
            --muted: #94a3b8;
            --text: #f1f5f9;
            --glass-bg: linear-gradient(135deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.8));
            --glass-border: 1px solid rgba(100, 116, 139, 0.2);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        *{box-sizing:border-box}html,body{height:100%}
        html{background:var(--bg)}
        [data-theme="dark"] html{background:#0f172a}
        body{margin:0;padding:28px;font-family:Inter,'Segoe UI',Roboto;background:var(--bg);background-image:linear-gradient(rgba(255,255,255,0.86),rgba(255,255,255,0.86)),var(--bg-img);background-size:cover;background-position:center;color:var(--text)}

        [data-theme="dark"] body {
            background-image: linear-gradient(rgba(15,23,42,0.9), rgba(15,23,42,0.9)), var(--bg-img);
        }
        main{
            max-width:var(--container);
            margin:0 auto;
            min-height:68vh;
            padding:28px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: var(--glass-border);
            border-radius: var(--radius);
            box-shadow: var(--glass-shadow);
        }
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap');
        header{display:flex;align-items:center;justify-content:space-between;background:var(--glass-bg);color:var(--text);padding:16px 20px;border-radius:var(--radius);box-shadow:var(--shadow);margin-bottom:18px;border:1px solid rgba(2,6,23,0.08)}
        header h1{margin:0;font-size:1.6rem;font-family:'Poppins',sans-serif;font-weight:600;letter-spacing:0.5px;background:linear-gradient(90deg,var(--accent),var(--primary));-webkit-background-clip:text;background-clip:text;color:transparent}

        [data-theme="dark"] header {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.8));
            border: 1px solid rgba(100, 116, 139, 0.2);
            color: var(--text);
        }

        .theme-toggle {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease;
        }

        .theme-toggle:hover {
            background: var(--accent);
        }
        input{padding:10px;border-radius:10px;border:1px solid #e6eef8;background:var(--card);min-width:150px;margin:8px;color:var(--text)}
        button{padding:10px 14px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--primary),var(--accent));color:#fff;cursor:pointer}

        [data-theme="dark"] input {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(100, 116, 139, 0.3);
            color: var(--text);
        }

        [data-theme="dark"] input[type="month"] {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(100, 116, 139, 0.3);
            color: var(--text);
        }

        [data-theme="dark"] header {
            border: 1px solid rgba(100, 116, 139, 0.2);
        }

        [data-theme="dark"] table {
            color: var(--text);
        }

        [data-theme="dark"] th {
            border-bottom: 2px solid rgba(100, 116, 139, 0.3) !important;
            color: var(--text);
        }

        [data-theme="dark"] td {
            border-bottom: 1px solid rgba(100, 116, 139, 0.2);
            color: var(--text);
        }

        [data-theme="dark"] tbody tr:hover {
            background: rgba(100, 116, 139, 0.1);
        }
        .charts-container{
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 18px 0;
        }
        .chart-wrapper{
            background: var(--glass-bg);
            border-radius: var(--radius);
            border: var(--glass-border);
            box-shadow: var(--glass-shadow);
            padding:16px;
            backdrop-filter: blur(5px);
        }
        .chart-wrapper h3{
            margin: 0 0 12px 0;
            text-align: center;
            color: var(--text);
            font-size: 1.1rem;
        }
        canvas{
            display:block;
            margin:0 auto;
            max-width:100%;
        }
        @media (max-width: 768px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
        }
        #summary{
            margin-top:12px;
            font-weight:600;
            padding: 12px;
            background: var(--glass-bg);
            border-radius: var(--radius);
            border: var(--glass-border);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }
        .table-container {
            margin-top: 30px;
            background: var(--glass-bg);
            border-radius: var(--radius);
            padding: 20px;
            border: var(--glass-border);
            box-shadow: var(--glass-shadow);
            backdrop-filter: blur(5px);
        }
        footer{margin-top:36px;text-align:center;color:var(--muted)}
    </style>
</head>
<body>
    <header>
        <div style="display: flex; align-items: center; gap: 12px;">
            <img src="images/logo.png" alt="ExpenseWise Logo" class="site-logo">
            <h1>ExpenseWise</h1>
        </div>
        <button class="theme-toggle" onclick="toggleTheme()">ðŸŒ™ Dark Mode</button>
    </header>
    <main>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <h1>Entertainment Expenses</h1>
        <div style="margin-bottom: 20px;">
            <label for="expenseMonth">Select Month: </label>
            <input type="month" id="expenseMonth" style="padding: 10px; border-radius: 10px; border: 1px solid #e6eef8; background: var(--card); color: var(--text);" />
        </div>
        <input type="number" id="movies" placeholder="Movies (â‚¹)" />
        <input type="number" id="parties" placeholder="Parties (â‚¹)" />
        <input type="number" id="gatherings" placeholder="Family Gatherings (â‚¹)" />
        <button onclick="showChart()">Show Chart</button>
        <button onclick="saveData()">Save Data</button>
        <button onclick="showTable()">Show Table</button>
        <button onclick="clearAllData()" style="background: linear-gradient(90deg, #dc2626, #ef4444); margin-left: 10px;">Clear All Data</button>
        <div id="summary"></div>
        
        <div class="chart-wrapper" style="max-width: 500px; margin: 18px auto;">
            <h3>Current Entertainment Breakdown</h3>
            <canvas id="entertainmentChart"></canvas>
        </div>
        
        <div class="chart-wrapper" style="max-width: 900px; margin: 18px auto;">
            <h3>Monthly Trends</h3>
            <canvas id="monthlyChart"></canvas>
        </div>

        <div class="table-container" style="margin-top: 20px;">
            <table class="expense-table" style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr>
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e6eef8;">Date</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e6eef8;">Movies</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e6eef8;">Parties</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e6eef8;">Gatherings</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e6eef8;">Total</th>
                    </tr>
                </thead>
                <tbody id="expenseTableBody"></tbody>
                <tfoot>
                    <tr>
                        <td style="padding: 12px; font-weight: bold;">Total</td>
                        <td id="totalMovies" style="padding: 12px;">â‚¹0</td>
                        <td id="totalParties" style="padding: 12px;">â‚¹0</td>
                        <td id="totalGatherings" style="padding: 12px;">â‚¹0</td>
                        <td id="grandTotal" style="padding: 12px; font-weight: bold;">â‚¹0</td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <script>
            // Set current month as default and initialize
            window.addEventListener('load', () => {
                const today = new Date();
                const month = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0');
                document.getElementById('expenseMonth').value = month;
                updateTable();
            });

            // Update data when month changes
            document.getElementById('expenseMonth').addEventListener('change', () => {
                updateTable();
            });

            function updateTable() {
                const tableBody = document.getElementById('expenseTableBody');
                if (!tableBody) return;
                tableBody.innerHTML = '';

                const expenses = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('entertainmentExpenses_')) {
                        try {
                            const data = JSON.parse(localStorage.getItem(key));
                            if (data && data.date) { expenses.push(data); }
                        } catch (e) { /* ignore malformed */ }
                    }
                }

                expenses.sort((a, b) => new Date(b.date) - new Date(a.date));

                let totalMovies = 0, totalParties = 0, totalGatherings = 0;

                expenses.forEach(expense => {
                    const row = document.createElement('tr');
                    const total = (expense.movies || 0) + (expense.parties || 0) + (expense.gatherings || 0);
                    row.innerHTML = `
                        <td style="padding: 12px; border-bottom: 1px solid #e6eef8; cursor: pointer;" onclick="loadExpense('${expense.date}')">
                            ${expense.date}
                        </td>
                        <td style="padding: 12px; border-bottom: 1px solid #e6eef8;">â‚¹${expense.movies || 0}</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e6eef8;">â‚¹${expense.parties || 0}</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e6eef8;">â‚¹${expense.gatherings || 0}</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e6eef8;">â‚¹${total}</td>
                    `;

                    tableBody.appendChild(row);

                    totalMovies += expense.movies || 0;
                    totalParties += expense.parties || 0;
                    totalGatherings += expense.gatherings || 0;
                });

                document.getElementById('totalMovies').textContent = `â‚¹${totalMovies}`;
                document.getElementById('totalParties').textContent = `â‚¹${totalParties}`;
                document.getElementById('totalGatherings').textContent = `â‚¹${totalGatherings}`;
                document.getElementById('grandTotal').textContent = `â‚¹${totalMovies + totalParties + totalGatherings}`;
            }

            function loadExpense(date) {
                    document.getElementById('expenseMonth').value = date;
                    const data = JSON.parse(localStorage.getItem(`entertainmentExpenses_${date}`));
                if (data) {
                    document.getElementById('movies').value = data.movies || '';
                    document.getElementById('parties').value = data.parties || '';
                    document.getElementById('gatherings').value = data.gatherings || '';
                    showChart();
                }
            }

            function showChart() {
                // Get current values
                const movies = parseInt(document.getElementById('movies').value) || 0;
                const parties = parseInt(document.getElementById('parties').value) || 0;
                const gatherings = parseInt(document.getElementById('gatherings').value) || 0;
                const total = movies + parties + gatherings;

                // Update UI
                document.getElementById('summary').innerHTML = `<h3>Total Entertainment Expenses: â‚¹${total}</h3>`;

                // Create pie chart for current data
                const ctx = document.getElementById('entertainmentChart').getContext('2d');
                
                // Destroy existing chart if it exists
                if (window.entertainmentChartInstance) {
                    window.entertainmentChartInstance.destroy();
                }

                window.entertainmentChartInstance = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['Movies', 'Parties', 'Family Gatherings'],
                        datasets: [{
                            data: [movies, parties, gatherings],
                            backgroundColor: ['#ff6b6b', '#4ecdc4', '#45b7d1'],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: '#f1f5f9',
                                    padding: 20
                                }
                            }
                        }
                    }
                });

                // Update monthly chart
                updateMonthlyChart();
            }

            function saveData() {
                const movies = parseInt(document.getElementById('movies').value) || 0;
                const parties = parseInt(document.getElementById('parties').value) || 0;
                const gatherings = parseInt(document.getElementById('gatherings').value) || 0;

                // Get month (YYYY-MM) for storage
                const monthKey = document.getElementById('expenseMonth').value;
            
                // Save data
                localStorage.setItem('entertainmentExpenses_' + monthKey, JSON.stringify({ 
                    date: monthKey,
                    movies: movies, 
                    parties: parties, 
                    gatherings: gatherings
                }));

                alert('Data saved successfully!');
            }

            function showTable() {
                // Update UI
                updateTable();
            }

            function updateMonthlyChart() {
                // Get all expenses and group by month
                const monthlyData = {};
                
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('entertainmentExpenses_')) {
                        const data = JSON.parse(localStorage.getItem(key));
                        const month = data.date.substring(0, 7); // Get YYYY-MM
                        
                        if (!monthlyData[month]) {
                            monthlyData[month] = { movies: 0, parties: 0, gatherings: 0 };
                        }
                        
                        monthlyData[month].movies += data.movies;
                        monthlyData[month].parties += data.parties;
                        monthlyData[month].gatherings += data.gatherings;
                    }
                }
                
                // Sort months
                const sortedMonths = Object.keys(monthlyData).sort();
                const last6Months = sortedMonths.slice(-6); // Get last 6 months
                
                const moviesData = last6Months.map(m => monthlyData[m].movies);
                const partiesData = last6Months.map(m => monthlyData[m].parties);
                const gatheringsData = last6Months.map(m => monthlyData[m].gatherings);
                
                // Format month labels
                const monthLabels = last6Months.map(m => {
                    const [year, month] = m.split('-');
                    const date = new Date(year, month - 1);
                    return date.toLocaleString('default', { month: 'short', year: '2-digit' });
                });
                
                // Destroy existing monthly chart if it exists
                const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
                if (window.monthlyChartInstance instanceof Chart) {
                    window.monthlyChartInstance.destroy();
                }
                
                // Create monthly bar chart
                window.monthlyChartInstance = new Chart(monthlyCtx, {
                    type: 'bar',
                    data: {
                        labels: monthLabels,
                        datasets: [
                            {
                                label: 'Movies',
                                data: moviesData,
                                backgroundColor: '#FF6384',
                            },
                            {
                                label: 'Parties',
                                data: partiesData,
                                backgroundColor: '#36A2EB',
                            },
                            {
                                label: 'Family Gatherings',
                                data: gatheringsData,
                                backgroundColor: '#FFCE56',
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                            x: {
                                stacked: true,
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return 'â‚¹' + value;
                                    }
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: â‚¹${context.raw}`;
                                    }
                                }
                            },
                            legend: { 
                                position: 'bottom' 
                            }
                        }
                    }
                });
            }

            // Theme toggle functionality
            function toggleTheme() {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                
                const toggleBtn = document.querySelector('.theme-toggle');
                toggleBtn.textContent = newTheme === 'dark' ? 'â˜€ï¸ Light Mode' : 'ðŸŒ™ Dark Mode';
            }

            // Load saved theme
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            const toggleBtn = document.querySelector('.theme-toggle');
            if (toggleBtn) {
                toggleBtn.textContent = savedTheme === 'dark' ? 'â˜€ï¸ Light Mode' : 'ðŸŒ™ Dark Mode';
            }

            function clearAllData() {
                if (confirm('Are you sure you want to clear all entertainment expense data? This cannot be undone.')) {
                    // Get all keys from localStorage
                    const keys = Object.keys(localStorage);
                    
                    // Remove only entertainment-related data
                    let deletedCount = 0;
                    keys.forEach(key => {
                        if (key.startsWith('entertainmentExpenses_')) {
                            localStorage.removeItem(key);
                            deletedCount++;
                        }
                    });
                    
                    // Clear form fields
                    document.getElementById('movies').value = '';
                    document.getElementById('parties').value = '';
                    document.getElementById('gatherings').value = '';
                    
                    // Clear charts
                    if (window.entChartInstance) {
                        window.entChartInstance.destroy();
                        window.entChartInstance = null;
                    }
                    if (window.monthlyChartInstance) {
                        window.monthlyChartInstance.destroy();
                        window.monthlyChartInstance = null;
                    }
                    
                    // Clear summary
                    document.getElementById('summary').innerHTML = '';
                    
                    // Update table
                    updateTable();
                    
                    alert(`Successfully cleared ${deletedCount} entertainment expense records.`);
                }
            }

            // Initialize table and expose functions
            updateTable();
            updateMonthlyChart();
            window.showChart = showChart;
            window.loadExpense = loadExpense;
        </script>
    </main>

    <footer>
        Beware of little expenses. A small leak will sink a great ship.
    </footer>
</body>
</html>