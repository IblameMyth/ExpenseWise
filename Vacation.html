<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Vacation</title>
  <link rel="stylesheet" href="styles.css">
  <script src="expense-utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg:#f8fafc;
      --card:rgba(255, 255, 255, 0.9);
      --muted:#6b7280;
      --text:#0f172a;
      --primary:#2563eb;
      --accent:#0ea5a4;
      --radius:12px;
      --shadow:0 8px 26px rgba(15,23,42,0.06);
      --container:1100px;
      --bg-img:url('https://images.unsplash.com/photo-1542223616-1e7b2d2b02d9?auto=format&fit=crop&w=1500&q=80');
      --glass-bg: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
      --glass-border: 1px solid rgba(255, 255, 255, 0.2);
      --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    /* Dark mode variables */
    [data-theme="dark"] {
      --bg: #0f172a;
      --card: rgba(30, 41, 59, 0.9);
      --muted: #94a3b8;
      --text: #f1f5f9;
      --glass-bg: linear-gradient(135deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.8));
      --glass-border: 1px solid rgba(100, 116, 139, 0.2);
      --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    *{box-sizing:border-box}html,body{height:100%}
    html{background:var(--bg)}
    [data-theme="dark"] html{background:#0f172a}
    body{margin:0;padding:28px;font-family:Inter,'Segoe UI',Roboto;background:var(--bg);background-image:linear-gradient(rgba(255,255,255,0.86),rgba(255,255,255,0.86)),var(--bg-img);background-size:cover;background-position:center;color:var(--text)}

    [data-theme="dark"] body {
      background-image: linear-gradient(rgba(15,23,42,0.9), rgba(15,23,42,0.9)), var(--bg-img);
    }
    main{
      max-width:var(--container);
      margin:0 auto;
      min-height:68vh;
      padding:28px;
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      border: var(--glass-border);
      border-radius: var(--radius);
      box-shadow: var(--glass-shadow);
    }
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap');
    header{display:flex;align-items:center;justify-content:space-between;background:var(--glass-bg);color:var(--text);padding:16px 20px;border-radius:var(--radius);box-shadow:var(--shadow);margin-bottom:18px;border:1px solid rgba(2,6,23,0.08)}
    header h1{margin:0;font-size:1.6rem;font-family:'Poppins',sans-serif;font-weight:600;letter-spacing:0.5px;background:linear-gradient(90deg,var(--accent),var(--primary));-webkit-background-clip:text;background-clip:text;color:transparent}

    [data-theme="dark"] header {
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.8));
      border: 1px solid rgba(100, 116, 139, 0.2);
      color: var(--text);
    }

    .theme-toggle {
      background: var(--primary);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s ease;
    }

    .theme-toggle:hover {
      background: var(--accent);
    }
    input[type="number"]{padding:10px;border-radius:10px;border:1px solid #e6eef8;background:var(--card);min-width:150px;margin:8px;color:var(--text)}
    button{padding:10px 14px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--primary),var(--accent));color:#fff;cursor:pointer}

    [data-theme="dark"] input[type="number"], [data-theme="dark"] input[type="month"] {
        background: rgba(30, 41, 59, 0.8);
        border: 1px solid rgba(100, 116, 139, 0.3);
        color: var(--text);
    }

    [data-theme="dark"] header {
        border: 1px solid rgba(100, 116, 139, 0.2);
    }
    .charts-container{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin:18px 0}
    .chart-wrapper{background:var(--card);border-radius:12px;box-shadow:0 8px 24px rgba(2,6,23,0.06);padding:16px}
    .chart-wrapper h3{margin:0 0 12px 0;text-align:center;color:var(--text);font-size:1.1rem}
    canvas{display:block;margin:0 auto;max-width:100%}
    @media (max-width:768px){.charts-container{grid-template-columns:1fr}}
    #summary{margin-top:12px;font-weight:700}
    footer{margin-top:36px;text-align:center;color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <div style="display: flex; align-items: center; gap: 12px;">
      <img src="images/logo.png" alt="ExpenseWise Logo" class="site-logo">
      <h1>ExpenseWise</h1>
    </div>
    <button class="theme-toggle" onclick="toggleTheme()">ðŸŒ™ Dark Mode</button>
  </header>

  <main>
    <h2>Vacation Expenses</h2>
    <div style="margin-bottom: 20px;">
      <label for="expenseMonth">Select Month: </label>
      <input type="month" id="expenseMonth" style="padding: 10px; border-radius: 10px; border: 1px solid #e6eef8;" />
    </div>
    <input type="number" id="tickets" placeholder="Tickets (₹‚¹)" />
    <input type="number" id="hostel" placeholder="Hostel (₹‚¹)" />
    <input type="number" id="food" placeholder="Food (₹‚¹)" />
    <input type="number" id="traveling" placeholder="Traveling (₹‚¹)" />
    <br />
    <button onclick="showVacationChart()">Show Chart</button>
    <button onclick="saveData()">Save Data</button>
    <button onclick="showTable()">Show Table</button>
    <button onclick="clearAllData()" style="background: linear-gradient(90deg, #dc2626, #ef4444); margin-left: 10px;">Clear All Data</button>
    <div id="summary"></div>
    
    <div class="chart-wrapper" style="max-width: 500px; margin: 18px auto;">
      <h3>Current Vacation Breakdown</h3>
      <canvas id="vacationChart"></canvas>
    </div>
    
    <div class="chart-wrapper" style="max-width: 900px; margin: 18px auto;">
      <h3>Monthly Trends</h3>
      <canvas id="monthlyChart"></canvas>
    </div>

    <div class="table-container" style="margin-top: 20px;">
      <table class="expense-table" style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr>
            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e6eef8;">Date</th>
            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e6eef8;">Tickets</th>
            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e6eef8;">Hostel</th>
            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e6eef8;">Food</th>
            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e6eef8;">Traveling</th>
            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e6eef8;">Total</th>
          </tr>
        </thead>
        <tbody id="expenseTableBody"></tbody>
        <tfoot>
          <tr>
            <td style="padding: 12px; font-weight: bold;">Total</td>
            <td id="totalTickets" style="padding: 12px;">₹‚¹0</td>
            <td id="totalHostel" style="padding: 12px;">₹‚¹0</td>
            <td id="totalFood" style="padding: 12px;">₹‚¹0</td>
            <td id="totalTraveling" style="padding: 12px;">₹‚¹0</td>
            <td id="grandTotal" style="padding: 12px; font-weight: bold;">₹‚¹0</td>
          </tr>
        </tfoot>
      </table>
    </div>
  </main>

  <footer>
    Travel is the only thing you buy that makes you richer.
  </footer>

  <script>
    // Set current month as default
    window.addEventListener('load', function() {
      const today = new Date();
      const month = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0');
      document.getElementById('expenseMonth').value = month;
      
      // Hide table initially
      const tableContainer = document.querySelector('.table-container');
      if (tableContainer) {
        tableContainer.style.display = 'none';
      }

      // Load saved data from XML and populate localStorage
      fetch('expenses.xml')
        .then(response => response.text())
        .then(str => (new window.DOMParser()).parseFromString(str, "text/xml"))
        .then(xml => {
          // Find the current month's node
          const monthNode = Array.from(xml.getElementsByTagName('month')).find(m => 
            m.getAttribute('id') === month
          );
          
          if (monthNode) {
            const vacationNode = monthNode.getElementsByTagName('vacation')[0];
            if (vacationNode) {
              const data = {
                tickets: Number(vacationNode.getElementsByTagName('tickets')[0]?.textContent || 0),
                hostel: Number(vacationNode.getElementsByTagName('hostel')[0]?.textContent || 0),
                food: Number(vacationNode.getElementsByTagName('food')[0]?.textContent || 0),
                traveling: Number(vacationNode.getElementsByTagName('traveling')[0]?.textContent || 0)
              };

              // Save to localStorage with month date for consistency
              localStorage.setItem('vacationExpenses_' + month, JSON.stringify({ date: month, ...data }));
            }
          }
          
          // Now load the data from localStorage
          loadMonthlyData(month);
        })
        .catch(error => {
          console.error('Error loading expenses:', error);
          loadMonthlyData(month);
        });
    });

    // Load data for selected month
    document.getElementById('expenseMonth').addEventListener('change', function() {
      loadMonthlyData(this.value);
    });

    function updateTable() {
      const tableBody = document.getElementById('expenseTableBody');
      if (!tableBody) return;
      tableBody.innerHTML = '';

      const expenses = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith('vacationExpenses_')) {
          try {
            const data = JSON.parse(localStorage.getItem(key));
            if (data && data.date) { expenses.push(data); }
          } catch (e) { /* ignore malformed */ }
        }
      }

      expenses.sort((a, b) => new Date(b.date) - new Date(a.date));

      // Check if there's no data
      if (expenses.length === 0) {
        const noDataRow = document.createElement('tr');
        noDataRow.innerHTML = `
          <td colspan="6" style="padding: 20px; text-align: center; color: var(--muted); font-style: italic;">No data available. Add expenses and click "Show Table" to see them here.</td>
        `;
        tableBody.appendChild(noDataRow);
        
        // Reset totals
        document.getElementById('totalTickets').textContent = '₹‚¹0';
        document.getElementById('totalHostel').textContent = '₹‚¹0';
        document.getElementById('totalFood').textContent = '₹‚¹0';
        document.getElementById('totalTraveling').textContent = '₹‚¹0';
        document.getElementById('grandTotal').textContent = '₹‚¹0';
        return;
      }

      let totalTickets = 0, totalHostel = 0, totalFood = 0, totalTraveling = 0;

      expenses.forEach(expense => {
        const row = document.createElement('tr');
        const total = (expense.tickets || 0) + (expense.hostel || 0) + 
                     (expense.food || 0) + (expense.traveling || 0);
        row.innerHTML = `
          <td style="padding: 12px; border-bottom: 1px solid #e6eef8; cursor: pointer;" onclick="loadExpense('${expense.date}')">
            ${expense.date}
          </td>
          <td style="padding: 12px; border-bottom: 1px solid #e6eef8;">₹‚¹${expense.tickets || 0}</td>
          <td style="padding: 12px; border-bottom: 1px solid #e6eef8;">₹‚¹${expense.hostel || 0}</td>
          <td style="padding: 12px; border-bottom: 1px solid #e6eef8;">₹‚¹${expense.food || 0}</td>
          <td style="padding: 12px; border-bottom: 1px solid #e6eef8;">₹‚¹${expense.traveling || 0}</td>
          <td style="padding: 12px; border-bottom: 1px solid #e6eef8;">₹‚¹${total}</td>
        `;

        tableBody.appendChild(row);

        totalTickets += expense.tickets || 0;
        totalHostel += expense.hostel || 0;
        totalFood += expense.food || 0;
        totalTraveling += expense.traveling || 0;
      });

      document.getElementById('totalTickets').textContent = `₹‚¹${totalTickets}`;
      document.getElementById('totalHostel').textContent = `₹‚¹${totalHostel}`;
      document.getElementById('totalFood').textContent = `₹‚¹${totalFood}`;
      document.getElementById('totalTraveling').textContent = `₹‚¹${totalTraveling}`;
      document.getElementById('grandTotal').textContent = 
        `₹‚¹${totalTickets + totalHostel + totalFood + totalTraveling}`;
    }

    function loadMonthlyData(monthKey) {
      // First try localStorage for immediate data
      const savedData = localStorage.getItem('vacationExpenses_' + monthKey);
      if (savedData) {
        const data = JSON.parse(savedData);
        document.getElementById('tickets').value = data.tickets || '';
        document.getElementById('hostel').value = data.hostel || '';
        document.getElementById('food').value = data.food || '';
        document.getElementById('traveling').value = data.traveling || '';
        showVacationChart(); // Show chart with saved data
      } else {
        // If not in localStorage, try loading from XML
        fetch('expenses.xml')
          .then(response => response.text())
          .then(str => (new window.DOMParser()).parseFromString(str, "text/xml"))
          .then(xml => {
            const monthNode = Array.from(xml.getElementsByTagName('month')).find(m => 
              m.getAttribute('id') === monthKey
            );
            
            if (monthNode) {
              const vacationNode = monthNode.getElementsByTagName('vacation')[0];
              if (vacationNode) {
                const data = {
                  tickets: Number(vacationNode.getElementsByTagName('tickets')[0]?.textContent || 0),
                  hostel: Number(vacationNode.getElementsByTagName('hostel')[0]?.textContent || 0),
                  food: Number(vacationNode.getElementsByTagName('food')[0]?.textContent || 0),
                  traveling: Number(vacationNode.getElementsByTagName('traveling')[0]?.textContent || 0)
                };

                // Update the form
                document.getElementById('tickets').value = data.tickets || '';
                document.getElementById('hostel').value = data.hostel || '';
                document.getElementById('food').value = data.food || '';
                document.getElementById('traveling').value = data.traveling || '';

                // Save to localStorage for future use (with date key for table consistency)
                localStorage.setItem('vacationExpenses_' + monthKey, JSON.stringify({ date: monthKey, ...data }));
                showVacationChart();
                return;
              }
            }
            
            // If no data found, clear the form
            clearForm();
          })
          .catch(error => {
            console.error('Error loading expenses:', error);
            clearForm();
          });
      }
      // Removed updateTable() call - table only shows when user clicks "Show Table" button
    }

    function clearForm() {
      document.getElementById('tickets').value = '';
      document.getElementById('hostel').value = '';
      document.getElementById('food').value = '';
      document.getElementById('traveling').value = '';
      document.getElementById('summary').innerHTML = '';
      if (window.vacationChart) {
        window.vacationChart.destroy();
      }
    }

    function loadExpense(date) {
        document.getElementById('expenseMonth').value = date;
        const data = JSON.parse(localStorage.getItem(`vacationExpenses_${date}`));
      if (data) {
        document.getElementById('tickets').value = data.tickets || '';
        document.getElementById('hostel').value = data.hostel || '';
        document.getElementById('food').value = data.food || '';
        document.getElementById('traveling').value = data.traveling || '';
        showVacationChart();
      }
    }

    function showVacationChart() {
      const tickets = parseInt(document.getElementById('tickets').value) || 0;
      const hostel = parseInt(document.getElementById('hostel').value) || 0;
      const food = parseInt(document.getElementById('food').value) || 0;
      const traveling = parseInt(document.getElementById('traveling').value) || 0;
      const total = tickets + hostel + food + traveling;

      // Update summary
      document.getElementById('summary').innerHTML = `<h3>Total Vacation Expenses: ₹‚¹${total}</h3>`;

      // Create pie chart for current data
      const ctx = document.getElementById('vacationChart').getContext('2d');
      
      // Destroy existing chart if it exists
      if (window.vacationChartInstance) {
        window.vacationChartInstance.destroy();
      }

      window.vacationChartInstance = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: ['Tickets', 'Hostel', 'Food', 'Traveling'],
          datasets: [{
            data: [tickets, hostel, food, traveling],
            backgroundColor: ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4'],
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                color: '#f1f5f9',
                padding: 20
              }
            }
          }
        }
      });

      // Update monthly chart
      updateMonthlyChart();
    }

    function saveData() {
      const tickets = parseInt(document.getElementById('tickets').value) || 0;
      const hostel = parseInt(document.getElementById('hostel').value) || 0;
      const food = parseInt(document.getElementById('food').value) || 0;
      const traveling = parseInt(document.getElementById('traveling').value) || 0;

      // Get the month (YYYY-MM)
      const monthKey = document.getElementById('expenseMonth').value;
    
      // Save data to localStorage
      const expenseData = {
        date: monthKey,
        tickets: tickets, 
        hostel: hostel, 
        food: food, 
        traveling: traveling
      };

      // Save to localStorage for immediate use
      localStorage.setItem('vacationExpenses_' + monthKey, JSON.stringify(expenseData));

      // Save to XML via PHP
      fetch('save_expense.php', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          type: 'vacation',
          date: monthKey,
          tickets: tickets,
          hostel: hostel,
          food: food,
          traveling: traveling
        })
      })
      .catch(error => console.error('Error saving expense:', error));

      alert('Data saved successfully!');
    }

    function showTable() {
      // Get the table container
      const tableContainer = document.querySelector('.table-container');
      if (!tableContainer) return;
      
      // Make table visible
      tableContainer.style.display = 'block';
      
      // Update table
      updateTable();
    }

    function updateMonthlyChart() {
      // Get all expenses and group by month
      const monthlyData = {};
      
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('vacationExpenses_')) {
          const data = JSON.parse(localStorage.getItem(key));
          const month = data.date.substring(0, 7); // Get YYYY-MM
          
          if (!monthlyData[month]) {
            monthlyData[month] = { tickets: 0, hostel: 0, food: 0, traveling: 0 };
          }
          
          monthlyData[month].tickets += data.tickets;
          monthlyData[month].hostel += data.hostel;
          monthlyData[month].food += data.food;
          monthlyData[month].traveling += data.traveling;
        }
      }
      
      // Sort months
      const sortedMonths = Object.keys(monthlyData).sort();
      const last6Months = sortedMonths.slice(-6); // Get last 6 months
      
      const ticketsData = last6Months.map(m => monthlyData[m].tickets);
      const hostelData = last6Months.map(m => monthlyData[m].hostel);
      const foodData = last6Months.map(m => monthlyData[m].food);
      const travelingData = last6Months.map(m => monthlyData[m].traveling);
      
      // Format month labels
      const monthLabels = last6Months.map(m => {
        const [year, month] = m.split('-');
        const date = new Date(year, month - 1);
        return date.toLocaleString('default', { month: 'short', year: '2-digit' });
      });
      
      // Destroy existing monthly chart if it exists
      const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
      if (window.monthlyChartInstance instanceof Chart) {
        window.monthlyChartInstance.destroy();
      }
      
      // Create monthly bar chart
      window.monthlyChartInstance = new Chart(monthlyCtx, {
        type: 'bar',
        data: {
          labels: monthLabels,
          datasets: [
            {
              label: 'Tickets',
              data: ticketsData,
              backgroundColor: 'rgba(255, 99, 132, 0.8)',
              borderColor: 'rgba(255, 99, 132, 1)',
              borderWidth: 2,
              borderRadius: 8,
              borderSkipped: false,
            },
            {
              label: 'Hostel',
              data: hostelData,
              backgroundColor: 'rgba(54, 162, 235, 0.8)',
              borderColor: 'rgba(54, 162, 235, 1)',
              borderWidth: 2,
              borderRadius: 8,
              borderSkipped: false,
            },
            {
              label: 'Food',
              data: foodData,
              backgroundColor: 'rgba(255, 206, 86, 0.8)',
              borderColor: 'rgba(255, 206, 86, 1)',
              borderWidth: 2,
              borderRadius: 8,
              borderSkipped: false,
            },
            {
              label: 'Traveling',
              data: travelingData,
              backgroundColor: 'rgba(75, 192, 192, 0.8)',
              borderColor: 'rgba(75, 192, 192, 1)',
              borderWidth: 2,
              borderRadius: 8,
              borderSkipped: false,
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              padding: 12,
              titleColor: '#fff',
              bodyColor: '#fff',
              borderColor: 'rgba(255, 255, 255, 0.2)',
              borderWidth: 1,
              displayColors: true,
              callbacks: {
                label: function(context) {
                  return `${context.dataset.label}: ₹‚¹${context.raw}`;
                }
              }
            },
            legend: { 
              position: 'top',
              labels: {
                padding: 15,
                font: {
                  size: 12,
                  weight: '500'
                },
                usePointStyle: true,
                pointStyle: 'circle'
              }
            }
          },
          scales: {
            x: {
              stacked: true,
              grid: {
                display: false
              },
              ticks: {
                font: {
                  size: 11,
                  weight: '500'
                }
              }
            },
            y: {
              stacked: true,
              beginAtZero: true,
              grid: {
                color: 'rgba(0, 0, 0, 0.05)',
                lineWidth: 1
              },
              ticks: {
                callback: function(value) {
                  return '₹‚¹' + value;
                },
                font: {
                  size: 11
                }
              }
            }
          }
        }
      });
    }

    // Initialize table on load
    updateTable();
    updateMonthlyChart();

    // Theme toggle functionality
    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      
      const toggleBtn = document.querySelector('.theme-toggle');
      toggleBtn.textContent = newTheme === 'dark' ? '₹˜€ï¸ Light Mode' : 'ðŸŒ™ Dark Mode';
    }

    // Load saved theme
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    const toggleBtn = document.querySelector('.theme-toggle');
    if (toggleBtn) {
      toggleBtn.textContent = savedTheme === 'dark' ? '₹˜€ï¸ Light Mode' : 'ðŸŒ™ Dark Mode';
    }

    // Clear all vacation expense data
    function clearAllData() {
      if (confirm('Are you sure you want to clear all vacation expense data? This cannot be undone.')) {
        // Get all keys from localStorage
        const keys = Object.keys(localStorage);
        
        // Remove only vacation-related data
        let deletedCount = 0;
        keys.forEach(key => {
          if (key.startsWith('vacationExpenses_')) {
            localStorage.removeItem(key);
            deletedCount++;
          }
        });
        
        // Clear form fields
        clearForm();
        
        // Clear charts
        if (window.monthlyChartInstance) {
          window.monthlyChartInstance.destroy();
          window.monthlyChartInstance = null;
        }
        
        // Update table
        updateTable();
        
        alert(`Successfully cleared ${deletedCount} vacation expense records.`);
      }
    }
  </script>
</body>
</html>

